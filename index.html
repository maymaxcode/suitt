<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SuitCds V35 Horizon</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* TEMA HORIZON BLUE */
        body { 
            background-color: #020617; /* Slate 950 */
            color: #e2e8f0; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, sans-serif;
            overflow-x: hidden;
        }

        /* FLOKOS DE NEVE SUAVES */
        .snowflake {
            position: fixed; top: -10px; background: rgba(56, 189, 248, 0.4);
            border-radius: 50%; pointer-events: none; z-index: 0; 
            animation: fall linear infinite;
            filter: blur(1px);
        }
        @keyframes fall { to { transform: translateY(110vh); opacity: 0; } }

        /* INPUT INVIS√çVEL */
        .phantom-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; z-index: 20; cursor: pointer;
        }

        /* GLASS CARD TECH */
        .glass { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            border: 1px solid rgba(56, 189, 248, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        .card {
            @apply glass; border-radius: 16px; position: relative; z-index: 10; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:active { transform: scale(0.98); border-color: #3b82f6; background: rgba(30, 58, 138, 0.3); }
        
        .slot-filled { border-color: #3b82f6; background: rgba(30, 58, 138, 0.2); }

        /* VISUALIZER CANVAS */
        canvas { width: 100%; height: 100%; border-radius: 12px; }

        /* TOAST */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px;
            font-weight: 700; font-size: 13px; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 100;
            display: flex; align-items: center; gap: 8px; width: max-content;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid #3b82f6;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen pb-44 selection:bg-blue-500/30">

    <audio id="preview-audio" playsinline webkit-playsinline></audio>
    <div id="toast"><i data-lucide="info" class="w-4 h-4 text-blue-400"></i> <span id="toast-msg">Info</span></div>

    <!-- HEADER & VISUALIZER -->
    <header class="pt-6 pb-6 px-6 bg-gradient-to-b from-[#020617] to-transparent sticky top-0 z-40">
        <div class="max-w-xl mx-auto">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center shadow-[0_0_20px_rgba(37,99,235,0.4)]">
                        <i data-lucide="waves" class="w-5 h-5 fill-current"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight text-white leading-tight">SuitCds</h1>
                        <p class="text-[10px] text-blue-400 font-bold tracking-[0.2em] uppercase">V35 HORIZON AI</p>
                    </div>
                </div>
                <div class="text-[10px] font-mono text-slate-500 bg-slate-900/50 px-2 py-1 rounded border border-slate-800">
                    WAV ‚Ä¢ NO-ZIP
                </div>
            </div>

            <!-- ANALYZER VISUALIZER -->
            <div class="h-16 w-full bg-slate-900/50 rounded-xl border border-blue-900/30 overflow-hidden relative">
                <canvas id="visualizer"></canvas>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <span id="vis-text" class="text-[10px] text-blue-500/50 font-mono tracking-widest">AGUARDANDO √ÅUDIO</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-5 space-y-6 relative z-10">

        <!-- 1. VINHETAS -->
        <section>
            <div class="flex justify-between items-end mb-3 px-1">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-4 h-4 rounded bg-slate-800 text-white flex items-center justify-center text-[10px]">1</span> 
                    Vinhetas
                </h2>
                <span id="slot-counter" class="text-[10px] text-blue-400 font-mono">0/2</span>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="card h-20 flex flex-col items-center justify-center gap-1 group" id="slot-1">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(0, this)">
                    <div id="icon-1" class="w-6 h-6 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-slate-500 group-hover:border-blue-500 transition-colors">1</div>
                    <span id="name-1" class="text-[10px] font-medium text-slate-400 truncate w-full px-3 text-center">Adicionar</span>
                    <button onclick="clearVinheta(0, event)" id="btn-clr-1" class="hidden absolute top-1 right-1 p-1 text-slate-500 hover:text-red-400 z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <div class="card h-20 flex flex-col items-center justify-center gap-1 group" id="slot-2">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(1, this)">
                    <div id="icon-2" class="w-6 h-6 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-slate-500 group-hover:border-blue-500 transition-colors">2</div>
                    <span id="name-2" class="text-[10px] font-medium text-slate-400 truncate w-full px-3 text-center">Adicionar</span>
                    <button onclick="clearVinheta(1, event)" id="btn-clr-2" class="hidden absolute top-1 right-1 p-1 text-slate-500 hover:text-red-400 z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            </div>
        </section>

        <!-- 2. SETUP AI -->
        <section>
            <div class="flex justify-between items-center mb-3 px-1">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-4 h-4 rounded bg-slate-800 text-white flex items-center justify-center text-[10px]">2</span> 
                    Configura√ß√£o Neural
                </h2>
            </div>
            
            <div class="card p-4 space-y-3">
                <div class="flex items-center justify-between border-b border-white/5 pb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-400">
                            <i data-lucide="brain-circuit" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <div class="text-xs font-bold text-white">IA Drop Hunter</div>
                            <div class="text-[9px] text-slate-500">Detecta batidas fortes</div>
                        </div>
                    </div>
                    <div class="text-[9px] font-mono text-green-400 bg-green-900/20 px-2 py-1 rounded">ATIVO</div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">C√°lculo de Tempo</label>
                        <select id="sel-pos" class="w-full bg-slate-900/50 text-xs text-white p-2 rounded-lg outline-none border border-slate-700">
                            <option value="dropMatch" selected>üéØ Match Drop (Preciso)</option>
                            <option value="calmSpot">üåä Calm Spot (Suave)</option>
                            <option value="intro">‚è≥ Intro (15s)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] text-slate-500 font-bold uppercase block mb-1">Tipo de Mix</label>
                        <select id="sel-mix" class="w-full bg-slate-900/50 text-xs text-white p-2 rounded-lg outline-none border border-slate-700">
                            <option value="ducking">üìª R√°dio (Baixa Fundo)</option>
                            <option value="overlay">üî• Colagem (Por Cima)</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. ARQUIVOS -->
        <section>
            <div class="flex justify-between items-end mb-3 px-1">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-4 h-4 rounded bg-slate-800 text-white flex items-center justify-center text-[10px]">3</span> 
                    Playlist
                </h2>
                <span id="track-counter" class="text-[10px] text-slate-500 font-mono">0/50</span>
            </div>

            <div class="flex gap-3 mb-4">
                <div class="card flex-1 h-12 flex flex-row items-center justify-center gap-2 active:bg-slate-800 cursor-pointer hover:border-blue-500/50 transition-colors">
                    <input type="file" class="phantom-input" id="inp-music" multiple accept="*">
                    <i data-lucide="music" class="w-4 h-4 text-blue-400"></i>
                    <span class="text-[10px] font-bold text-slate-300">SELECIONAR</span>
                </div>
            </div>

            <!-- LISTA -->
            <div id="list-container" class="hidden space-y-2 pb-4"></div>
            
            <div id="empty-msg" class="text-center py-12 border border-dashed border-slate-800 rounded-2xl">
                <p class="text-xs text-slate-600 font-medium">Nenhum arquivo</p>
            </div>
        </section>

    </main>

    <!-- FOOTER CONTROLS -->
    <footer class="fixed bottom-0 left-0 right-0 bg-[#020617]/95 backdrop-blur-xl border-t border-white/5 p-5 z-50 pb-8">
        <div class="max-w-xl mx-auto flex gap-3">
            <button id="btn-process" onclick="startProcessing()" disabled class="flex-1 bg-slate-900 text-slate-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-50">
                <span>AGUARDANDO...</span>
            </button>
            <button id="btn-download-all" onclick="downloadAllSequence()" class="hidden w-[45%] bg-blue-600 text-white h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-[0_0_25px_rgba(37,99,235,0.4)] hover:bg-blue-500 active:scale-95">
                <i data-lucide="layers" class="w-4 h-4"></i>
                <span>BAIXAR TODOS</span>
            </button>
        </div>
    </footer>

    <script>
        // --- SNOWFLAKES ---
        function createSnow() {
            const container = document.body;
            for(let i=0; i<20; i++) {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                flake.style.width = Math.random() * 3 + 1 + 'px';
                flake.style.height = flake.style.width;
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.opacity = Math.random() * 0.5 + 0.1;
                flake.style.animationDuration = Math.random() * 15 + 10 + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(flake);
            }
        }
        createSnow();

        // --- GLOBAL ---
        let audioCtx;
        let analyser;
        let vinhetaSlots = [null, null];
        let tracks = [];
        let isProcessing = false;
        let playingId = null;
        let isDownloadingAll = false;
        const MAX_TRACKS = 50;

        lucide.createIcons();

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                drawVisualizer();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        document.body.addEventListener('click', () => initAudio(), {once:true});

        function notify(msg, type='info') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.borderColor = type === 'error' ? '#ef4444' : '#3b82f6';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- VISUALIZER ---
        function drawVisualizer() {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            // Resize canvas
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;

            function render() {
                requestAnimationFrame(render);
                if(!playingId) { 
                    ctx.clearRect(0,0,canvas.width, canvas.height); 
                    return; 
                }

                analyser.getByteFrequencyData(dataArray);
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                for(let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 2;
                    // Gradiente Azul Neon
                    ctx.fillStyle = `rgba(56, 189, 248, ${barHeight/150})`; 
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
            render();
        }

        // --- VINHETA ---
        async function loadVinheta(idx, input) {
            const file = input.files[0];
            if(!file) return;
            initAudio();
            
            const nameEl = document.getElementById(`name-${idx+1}`);
            const iconEl = document.getElementById(`icon-${idx+1}`);
            nameEl.innerText = "Analisando...";
            
            try {
                const ab = await file.arrayBuffer();
                const buf = await audioCtx.decodeAudioData(ab);
                vinhetaSlots[idx] = { buffer: buf, duration: buf.duration, name: file.name };
                
                document.getElementById(`slot-${idx+1}`).classList.add('slot-filled');
                iconEl.className = "w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center";
                iconEl.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i>';
                nameEl.innerText = file.name;
                nameEl.classList.add('text-white');
                document.getElementById(`btn-clr-${idx+1}`).classList.remove('hidden');
                lucide.createIcons();
                updateState();
            } catch(e) {
                notify("Arquivo de √°udio inv√°lido", "error");
                nameEl.innerText = "Erro";
            }
            input.value = ''; 
        }

        function clearVinheta(idx, e) {
            e.preventDefault(); e.stopPropagation();
            vinhetaSlots[idx] = null;
            document.getElementById(`slot-${idx+1}`).classList.remove('slot-filled');
            const iconEl = document.getElementById(`icon-${idx+1}`);
            const nameEl = document.getElementById(`name-${idx+1}`);
            iconEl.className = "w-6 h-6 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-slate-500";
            iconEl.innerHTML = idx+1;
            nameEl.innerText = "Adicionar";
            nameEl.classList.remove('text-white');
            document.getElementById(`btn-clr-${idx+1}`).classList.add('hidden');
            updateState();
        }

        // --- M√öSICAS ---
        document.getElementById('inp-music').onchange = function() {
            if(this.files.length) {
                if(tracks.length + this.files.length > MAX_TRACKS) {
                    notify(`Limite de ${MAX_TRACKS} arquivos!`, "error"); return;
                }
                Array.from(this.files).forEach(f => {
                    tracks.push({ 
                        id: Math.random().toString(36).slice(2), 
                        file: f, status: 'pending', msg: 'Aguardando', blob: null, originalName: f.name, vinhetaTime: 0
                    });
                });
                updateState();
            }
            this.value = '';
        };

        window.remTrack = (id) => { 
            if(playingId === id) { document.getElementById('preview-audio').pause(); playingId = null; }
            tracks = tracks.filter(t => t.id !== id); 
            updateState(); 
        }

        // --- PLAYER COM VISUALIZER ---
        const audioEl = document.getElementById('preview-audio');
        let audioSourceNode = null;

        window.togglePlay = (id) => {
            const t = tracks.find(x => x.id === id);
            
            // Parar
            if(playingId) {
                audioEl.pause();
                playingId = null;
                document.getElementById('vis-text').style.display = 'block';
                if(id === playingId) { updateState(); return; }
            }

            // Tocar Novo
            if(t && t.blob) {
                initAudio();
                const url = URL.createObjectURL(t.blob);
                audioEl.src = url;
                
                // Conectar ao visualizador
                if(audioSourceNode) audioSourceNode.disconnect();
                audioSourceNode = audioCtx.createMediaElementSource(audioEl);
                audioSourceNode.connect(analyser);
                analyser.connect(audioCtx.destination);
                
                audioEl.play();
                playingId = id;
                document.getElementById('vis-text').style.display = 'none';
            }
            updateState();
        }

        window.jumpToVinheta = (id) => {
            const t = tracks.find(x => x.id === id);
            if(!t || !t.blob) return;

            if(playingId !== id) togglePlay(id);
            
            // Pular para 2s antes
            setTimeout(() => {
                const targetTime = Math.max(0, t.vinhetaTime - 2);
                audioEl.currentTime = targetTime;
                notify(`Preview em ${formatTime(targetTime)}`);
            }, 100);
        }

        audioEl.onended = () => { playingId = null; document.getElementById('vis-text').style.display = 'block'; updateState(); };

        function formatTime(sec) {
            const m = Math.floor(sec/60);
            const s = Math.floor(sec%60);
            return `${m}:${s<10?'0':''}${s}`;
        }

        // --- AI ANALYZER (DROP DETECTOR) ---
        function analyzeStructure(buffer, vinhetaDuration) {
            const sr = buffer.sampleRate;
            const data = buffer.getChannelData(0);
            const duration = buffer.duration;

            // Se for curta demais, bota no meio
            if(duration < 90) return (duration/2) - (vinhetaDuration/2);

            // ANALISAR O FINAL (√öltimos 40% da m√∫sica)
            // Procuramos um "Drop" (aumento s√∫bito de energia) ou uma parte calma.
            
            // Janela de busca: Do meio at√© 10s antes do fim
            const startScan = Math.floor(duration * 0.5 * sr);
            const endScan = Math.floor((duration - 20) * sr);
            const blockSize = sr; // 1 segundo por bloco

            let maxEnergyJump = 0;
            let dropTime = endScan / sr;

            // Percorre procurando o maior aumento de energia (Drop)
            let prevEnergy = 0;

            for(let i = startScan; i < endScan; i+=blockSize) {
                let energy = 0;
                for(let j=0; j<100; j++) { // Amostragem r√°pida
                    energy += Math.abs(data[i + j*10]);
                }
                
                // Se a energia dobrou, √© um drop
                if(i > startScan && energy > prevEnergy * 1.5) {
                    if (energy - prevEnergy > maxEnergyJump) {
                        maxEnergyJump = energy - prevEnergy;
                        dropTime = i / sr;
                    }
                }
                prevEnergy = energy;
            }

            // O PONTO IDEAL:
            // O drop acontece em `dropTime`. 
            // Queremos que a vinheta TERMINE um pouco antes do drop explodir.
            // Formula: DropTime - VinhetaDuration - 2s (Respiro)
            let placement = dropTime - vinhetaDuration - 2;

            // Seguran√ßa: Se o calculo jogar pro come√ßo negativo, ou muito perto do fim
            if (placement < 10) placement = 10;
            if (placement > duration - 20) placement = duration - 30;

            return placement;
        }

        // --- UPDATE UI ---
        function updateState() {
            const list = document.getElementById('list-container');
            const empty = document.getElementById('empty-msg');
            const btn = document.getElementById('btn-process');
            const btnDown = document.getElementById('btn-download-all');
            const activeV = vinhetaSlots.some(v=>v!==null);
            
            document.getElementById('slot-counter').innerText = `${vinhetaSlots.filter(x=>x).length}/2`;
            document.getElementById('track-counter').innerText = `${tracks.length}/${MAX_TRACKS}`;

            if(tracks.length > 0) {
                list.classList.remove('hidden');
                
                list.innerHTML = tracks.map(t => {
                    const isPlaying = playingId === t.id;
                    let controls = '';

                    if(t.status === 'done') {
                        controls = `
                        <div class="flex items-center gap-2">
                            <!-- BOT√ÉO DOWNLOAD INDIVIDUAL -->
                            <button onclick="downloadSingle('${t.id}')" title="Baixar" class="w-8 h-8 rounded-lg bg-slate-800 text-blue-400 border border-blue-900/30 hover:bg-blue-600 hover:text-white transition-all flex items-center justify-center">
                                <i data-lucide="arrow-down-to-line" class="w-4 h-4"></i>
                            </button>
                            
                            <!-- BOT√ÉO PREVIEW VINHETA -->
                            <button onclick="jumpToVinheta('${t.id}')" class="px-3 py-1.5 rounded-lg bg-slate-800 text-slate-300 text-[10px] font-bold flex items-center gap-1 border border-slate-700 hover:border-blue-500 active:scale-95 transition-all">
                                <span>VINHETA</span>
                                <span class="text-blue-500">${formatTime(t.vinhetaTime)}</span>
                            </button>

                            <!-- PLAY/PAUSE -->
                            <button onclick="togglePlay('${t.id}')" class="w-8 h-8 rounded-full ${isPlaying ? 'bg-white text-black animate-pulse' : 'bg-blue-600 text-white'} flex items-center justify-center transition-colors shadow-lg shadow-blue-900/30">
                                <i data-lucide="${isPlaying ? 'pause' : 'play'}" class="w-3 h-3 fill-current"></i>
                            </button>
                        </div>`;
                    } else if (t.status === 'processing') {
                         controls = `<span class="text-[10px] text-blue-400 animate-pulse">PROCESSANDO...</span>`;
                    } else if (t.status === 'downloaded') {
                        controls = `<span class="text-[10px] text-green-400 flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> BAIXADO</span>`;
                    }

                    return `
                    <div class="card p-3 flex items-center justify-between group border-l-2 ${t.status==='done'?'border-l-blue-500':'border-l-transparent'}">
                        <div class="flex items-center gap-3 overflow-hidden flex-1">
                            <div class="min-w-0">
                                <div class="text-xs text-white truncate font-medium">${t.originalName}</div>
                                <div class="text-[10px] text-slate-500">${t.msg}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 pl-2">
                            ${controls}
                            ${t.status !== 'done' ? `<button onclick="remTrack('${t.id}')" class="p-2 text-slate-600 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            } else {
                list.classList.add('hidden');
            }

            const canProcess = activeV && tracks.length > 0;
            const hasSuccess = tracks.some(t => t.status === 'done');
            
            if(isProcessing) {
                btn.disabled = true; 
                btn.className = "flex-1 bg-slate-800 text-slate-500 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerHTML = `<i data-lucide="cpu" class="w-4 h-4 animate-spin"></i> CALCULANDO IA...`;
            } else if(hasSuccess && !isProcessing && tracks.every(t=>t.status==='done' || t.status==='error' || t.status==='downloaded')) {
                btn.className = "flex-1 bg-slate-900 text-slate-500 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerText = "FINALIZADO";
                btn.disabled = true;
                btnDown.classList.remove('hidden');
            } else if(canProcess) {
                btn.disabled = false; 
                btn.className = "flex-1 bg-blue-600 text-white h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(37,99,235,0.4)] active:scale-95 transition-all hover:bg-blue-500";
                btn.innerHTML = `INICIAR MIXAGEM`;
                btnDown.classList.add('hidden');
            } else {
                btn.disabled = true; 
                btn.className = "flex-1 bg-slate-900 text-slate-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerText = !activeV ? "FALTA VINHETA" : "ADD M√öSICAS";
                btnDown.classList.add('hidden');
            }
            lucide.createIcons();
        }

        // --- PROCESSAMENTO PRINCIPAL ---
        async function startProcessing() {
            if(isProcessing) return;
            initAudio();
            isProcessing = true; 
            updateState();

            const vinheta = vinhetaSlots.find(v => v !== null);
            if(!vinheta) { notify("Vinheta necess√°ria!", "error"); isProcessing=false; return; }

            const posMode = document.getElementById('sel-pos').value;
            const mixMode = document.getElementById('sel-mix').value;

            for(let i=0; i<tracks.length; i++) {
                if(tracks[i].status !== 'pending') continue;

                tracks[i].status = 'processing'; 
                tracks[i].msg = 'Analisando Estrutura...';
                updateState();
                await new Promise(r => setTimeout(r, 20));

                try {
                    const ab = await tracks[i].file.arrayBuffer();
                    let trackBuffer;
                    try { trackBuffer = await audioCtx.decodeAudioData(ab); } catch(e) { throw new Error("Codec inv√°lido"); }

                    const vDur = vinheta.duration;
                    const tDur = trackBuffer.duration;
                    let startTime = 0;

                    // --- IA DE POSICIONAMENTO ---
                    if (posMode === 'dropMatch') {
                        // Acha o drop e subtrai o tempo da vinheta
                        startTime = analyzeStructure(trackBuffer, vDur);
                    } else if (posMode === 'calmSpot') {
                        // Acha o meio termo (simples)
                        startTime = (tDur / 2) - (vDur / 2);
                    } else {
                        startTime = Math.min(10, tDur/4);
                    }
                    
                    tracks[i].vinhetaTime = startTime;

                    const offlineCtx = new OfflineAudioContext(2, trackBuffer.length, trackBuffer.sampleRate);
                    const musicSrc = offlineCtx.createBufferSource(); musicSrc.buffer = trackBuffer;
                    const vinhetaSrc = offlineCtx.createBufferSource(); vinhetaSrc.buffer = vinheta.buffer;
                    const musicGain = offlineCtx.createGain();
                    const vinhetaGain = offlineCtx.createGain();

                    // MIXAGEM
                    if (mixMode === 'ducking') {
                        // Baixa a m√∫sica suavemente
                        musicGain.gain.setValueAtTime(1, startTime);
                        musicGain.gain.linearRampToValueAtTime(0.25, startTime + 0.3);
                        musicGain.gain.setValueAtTime(0.25, startTime + vDur - 0.3);
                        musicGain.gain.linearRampToValueAtTime(1, startTime + vDur);
                        vinhetaGain.gain.value = 1.1; // Vinheta +10%
                    } else {
                        // Overlay (Colagem)
                        musicGain.gain.value = 1.0;
                        vinhetaGain.gain.value = 1.3; // Vinheta +30%
                    }

                    musicSrc.connect(musicGain); musicGain.connect(offlineCtx.destination);
                    vinhetaSrc.connect(vinhetaGain); vinhetaGain.connect(offlineCtx.destination);
                    
                    musicSrc.start(0); 
                    vinhetaSrc.start(startTime);

                    tracks[i].msg = 'Renderizando WAV...'; updateState();
                    const renderedBuffer = await offlineCtx.startRendering();
                    tracks[i].blob = bufferToWave(renderedBuffer, renderedBuffer.length);
                    tracks[i].status = 'done';
                    tracks[i].msg = `Pronto (Vinheta em ${formatTime(startTime)})`;
                    
                    // Limpar RAM
                    tracks[i].file = null; 

                } catch(e) {
                    tracks[i].status = 'error';
                    tracks[i].msg = 'Erro ao processar';
                }
            }

            isProcessing = false;
            updateState();
            if(tracks.some(t => t.status === 'done')) notify("Mixagem conclu√≠da!", "success");
        }

        // --- WAV ENCODER ---
        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels, length = len * numOfChan * 2 + 44, buffer = new ArrayBuffer(length), view = new DataView(buffer), channels = [], i, sample, offset = 0, pos = 0;
            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157); setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan); setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan); setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - pos - 4);
            for(i=0; i<numOfChan; i++) channels.push(abuffer.getChannelData(i));
            while(pos < length) {
                for(i=0; i<numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][offset])); 
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0; 
                    view.setInt16(pos, sample, true); pos += 2;
                }
                offset++;
            }
            return new Blob([buffer], { type: "audio/wav" });
        }

        // --- DOWNLOAD SYSTEM ---
        
        // 1. Download Individual
        function downloadSingle(id) {
            const t = tracks.find(x => x.id === id);
            if(t && t.blob) {
                triggerDownload(t);
            }
        }

        // 2. Download Sequencial (Smart Queue)
        async function downloadAllSequence() {
            if(isDownloadingAll) return;
            isDownloadingAll = true;
            
            const btn = document.getElementById('btn-download-all');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> BAIXANDO...`;
            lucide.createIcons();

            const doneTracks = tracks.filter(t => t.status === 'done');
            
            if(doneTracks.length === 0) {
                notify("Nada para baixar.", "error");
                isDownloadingAll = false;
                btn.innerHTML = originalText;
                return;
            }

            notify(`Iniciando download de ${doneTracks.length} arquivos...`);

            // Loop com delay para n√£o travar o browser
            for(let i = 0; i < doneTracks.length; i++) {
                triggerDownload(doneTracks[i]);
                doneTracks[i].status = 'downloaded';
                updateState();
                
                // Espera 1.2 segundos entre downloads
                await new Promise(r => setTimeout(r, 1200));
            }

            notify("Downloads finalizados!", "success");
            isDownloadingAll = false;
            btn.innerHTML = originalText;
            lucide.createIcons();
        }

        function triggerDownload(t) {
            const a = document.createElement('a');
            const url = URL.createObjectURL(t.blob);
            a.href = url;
            let safeName = t.originalName.replace(/\.[^/.]+$/, "");
            a.download = `${safeName} (SuitCds).wav`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
    </script>
</body>
</html>

