<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SuitCds V33 Balanced</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* TEMA DEEP SPACE */
        body { 
            background-color: #030712; /* Gray 950 */
            color: #e2e8f0; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, sans-serif;
            overflow-x: hidden;
        }

        /* AMBIENTE */
        .ambient-light {
            position: fixed; top: 50%; left: 50%; width: 150vw; height: 150vw;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.03) 0%, transparent 70%);
            transform: translate(-50%, -50%); pointer-events: none; z-index: 0;
        }

        /* INPUT INVIS√çVEL */
        .phantom-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; z-index: 20; cursor: pointer;
        }

        /* GLASS CARD */
        .glass { 
            background: rgba(17, 24, 39, 0.8); 
            backdrop-filter: blur(24px); 
            -webkit-backdrop-filter: blur(24px); 
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        .card {
            @apply glass; border-radius: 20px; position: relative; z-index: 10; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:active { transform: scale(0.98); border-color: #0ea5e9; background: rgba(30, 41, 59, 0.9); }
        
        .slot-filled { border-color: #0ea5e9; background: rgba(14, 165, 233, 0.1); }
        
        /* TOAST */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #0f172a; color: #fff; padding: 12px 24px; border-radius: 50px;
            font-weight: 600; font-size: 13px; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 100;
            display: flex; align-items: center; gap: 8px; width: max-content;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid #334155;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen pb-44 selection:bg-sky-500/30">

    <div class="ambient-light"></div>
    <audio id="preview-audio" playsinline webkit-playsinline></audio>
    <div id="toast"><i data-lucide="info" class="w-4 h-4 text-sky-400"></i> <span id="toast-msg">Info</span></div>

    <!-- HEADER -->
    <header class="pt-8 pb-6 px-6 border-b border-white/5 bg-[#030712]/90 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-tr from-sky-600 to-indigo-600 text-white rounded-xl flex items-center justify-center shadow-lg shadow-sky-900/40">
                    <i data-lucide="equalizer" class="w-5 h-5 fill-current"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white leading-tight">SuitCds</h1>
                    <p class="text-[10px] text-sky-500 font-bold tracking-[0.2em] uppercase">V33 BALANCED</p>
                </div>
            </div>
            <div class="px-3 py-1 rounded-full bg-sky-950/30 border border-sky-900/50 text-[10px] font-mono text-sky-400">
                AUTO-MIX
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-5 space-y-8 relative z-10">

        <!-- 1. VINHETAS -->
        <section>
            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-4 h-4 rounded bg-slate-800 text-white flex items-center justify-center text-[10px]">1</span> 
                    Vinhetas
                </h2>
                <span id="slot-counter" class="text-[10px] text-sky-600 font-mono bg-sky-950/20 px-2 py-0.5 rounded border border-sky-900/20">0/2</span>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="card h-24 flex flex-col items-center justify-center gap-2 group" id="slot-1">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(0, this)">
                    <div id="icon-1" class="w-8 h-8 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-slate-500 group-hover:border-sky-500/50 transition-colors">1</div>
                    <span id="name-1" class="text-[11px] font-medium text-slate-400 truncate w-full px-3 text-center">Toque p/ add</span>
                    <button onclick="clearVinheta(0, event)" id="btn-clr-1" class="hidden absolute top-1 right-1 p-2 text-slate-500 hover:text-red-400 z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <div class="card h-24 flex flex-col items-center justify-center gap-2 group" id="slot-2">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(1, this)">
                    <div id="icon-2" class="w-8 h-8 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-slate-500 group-hover:border-sky-500/50 transition-colors">2</div>
                    <span id="name-2" class="text-[11px] font-medium text-slate-400 truncate w-full px-3 text-center">Toque p/ add</span>
                    <button onclick="clearVinheta(1, event)" id="btn-clr-2" class="hidden absolute top-1 right-1 p-2 text-slate-500 hover:text-red-400 z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            </div>
        </section>

        <!-- 2. SETUP -->
        <section>
            <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 px-1 flex items-center gap-2">
                <span class="w-4 h-4 rounded bg-slate-800 text-white flex items-center justify-center text-[10px]">2</span> 
                Intelig√™ncia
            </h2>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="card p-3 relative overflow-hidden">
                    <label class="text-[9px] text-sky-500 font-bold uppercase block mb-1">Algoritmo</label>
                    <select id="sel-pos" class="w-full bg-transparent text-xs text-white outline-none cursor-pointer appearance-none relative z-10 font-medium">
                        <option value="balancedAI" selected>üß† Smart (Meio/Calmo)</option>
                        <option value="safeZone">üõ°Ô∏è Zona Segura (70%)</option>
                        <option value="start">‚ñ∂Ô∏è In√≠cio (0:00)</option>
                        <option value="intro">‚è≥ Intro (0:15)</option>
                    </select>
                    <i data-lucide="chevron-down" class="w-3 h-3 text-slate-600 absolute right-3 bottom-3 z-0"></i>
                </div>
                <div class="card p-3 relative overflow-hidden">
                    <label class="text-[9px] text-sky-500 font-bold uppercase block mb-1">Mixagem</label>
                    <select id="sel-mix" class="w-full bg-transparent text-xs text-white outline-none cursor-pointer appearance-none relative z-10 font-medium">
                        <option value="ducking">üìª R√°dio (Suave)</option>
                        <option value="overlay">üî• Rave (Por Cima)</option>
                        <option value="cut">‚úÇÔ∏è Seco (Corte)</option>
                    </select>
                    <i data-lucide="chevron-down" class="w-3 h-3 text-slate-600 absolute right-3 bottom-3 z-0"></i>
                </div>
            </div>
            <p class="text-[10px] text-slate-600 mt-2 px-1">
                <i data-lucide="shield-check" class="w-3 h-3 inline mr-1 align-middle"></i>
                Prote√ß√£o Ativa: Ignora come√ßo e √∫ltimos 30s.
            </p>
        </section>

        <!-- 3. PLAYLIST -->
        <section>
            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-4 h-4 rounded bg-slate-800 text-white flex items-center justify-center text-[10px]">3</span> 
                    Arquivos
                </h2>
                <span id="track-counter" class="text-[10px] text-slate-500 font-mono bg-slate-900 px-2 py-0.5 rounded">0/50</span>
            </div>

            <div class="flex gap-3 mb-4">
                <div class="card flex-1 h-14 flex flex-row items-center justify-center gap-2 active:bg-slate-800 cursor-pointer relative overflow-hidden hover:border-sky-500/30 transition-colors">
                    <input type="file" class="phantom-input" id="inp-music" multiple accept="*">
                    <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center">
                        <i data-lucide="music" class="w-4 h-4 text-sky-400"></i>
                    </div>
                    <span class="text-[10px] font-bold text-slate-300">SELECIONAR</span>
                </div>
                <div class="card flex-1 h-14 flex flex-row items-center justify-center gap-2 active:bg-slate-800 cursor-pointer relative overflow-hidden hover:border-indigo-500/30 transition-colors">
                    <input type="file" class="phantom-input" id="inp-zip" accept="*">
                    <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center">
                        <i data-lucide="archive" class="w-4 h-4 text-indigo-400"></i>
                    </div>
                    <span class="text-[10px] font-bold text-slate-300">ABRIR ZIP</span>
                </div>
            </div>

            <!-- LISTA -->
            <div id="list-container" class="hidden space-y-2 pb-4"></div>
            
            <div id="empty-msg" class="text-center py-12 border border-dashed border-slate-800 rounded-2xl">
                <div class="w-12 h-12 rounded-full bg-slate-900 mx-auto flex items-center justify-center mb-3">
                    <i data-lucide="folder-open" class="w-5 h-5 text-slate-600"></i>
                </div>
                <p class="text-xs text-slate-500 font-medium">Nenhum arquivo</p>
                <p class="text-[10px] text-slate-600 mt-1">Formatos: MP3, WAV, M4A</p>
            </div>
        </section>

    </main>

    <!-- FOOTER -->
    <footer class="fixed bottom-0 left-0 right-0 bg-[#030712]/95 backdrop-blur-xl border-t border-white/5 p-5 z-50 pb-8">
        <div class="max-w-xl mx-auto flex gap-3">
            <button id="btn-process" onclick="startProcessing()" disabled class="flex-1 bg-slate-900 text-slate-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-50">
                <span>AGUARDANDO...</span>
            </button>
            <button id="btn-download" type="button" onclick="downloadZip(event)" class="hidden w-[45%] bg-sky-600 text-white h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-[0_0_20px_rgba(2,132,199,0.3)] hover:bg-sky-500 hover:shadow-sky-500/40 active:scale-95">
                <i data-lucide="package-check" class="w-4 h-4"></i>
                <span>BAIXAR TUDO</span>
            </button>
        </div>
    </footer>

    <script>
        // --- VARI√ÅVEIS GLOBAIS ---
        let audioCtx;
        let vinhetaSlots = [null, null];
        let tracks = [];
        let isProcessing = false;
        let playingId = null;
        const MAX_TRACKS = 50;

        lucide.createIcons();

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        document.body.addEventListener('click', () => initAudio(), {once:true});

        function notify(msg, type='info') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.borderColor = type === 'error' ? '#ef4444' : '#0ea5e9';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- VINHETA ---
        async function loadVinheta(idx, input) {
            const file = input.files[0];
            if(!file) return;
            initAudio();
            
            const nameEl = document.getElementById(`name-${idx+1}`);
            const iconEl = document.getElementById(`icon-${idx+1}`);
            nameEl.innerText = "Lendo...";
            
            try {
                const ab = await file.arrayBuffer();
                const buf = await audioCtx.decodeAudioData(ab);
                vinhetaSlots[idx] = { buffer: buf, duration: buf.duration, name: file.name };
                
                document.getElementById(`slot-${idx+1}`).classList.add('slot-filled');
                iconEl.className = "w-8 h-8 rounded-full bg-sky-600 text-white flex items-center justify-center shadow-[0_0_15px_rgba(2,132,199,0.5)]";
                iconEl.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                nameEl.innerText = file.name;
                nameEl.classList.add('text-white');
                document.getElementById(`btn-clr-${idx+1}`).classList.remove('hidden');
                lucide.createIcons();
                updateState();
            } catch(e) {
                notify("Erro: Arquivo inv√°lido", "error");
                nameEl.innerText = "Erro";
            }
            input.value = ''; 
        }

        function clearVinheta(idx, e) {
            e.preventDefault(); e.stopPropagation();
            vinhetaSlots[idx] = null;
            document.getElementById(`slot-${idx+1}`).classList.remove('slot-filled');
            const iconEl = document.getElementById(`icon-${idx+1}`);
            const nameEl = document.getElementById(`name-${idx+1}`);
            iconEl.className = "w-8 h-8 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-slate-500 transition-colors";
            iconEl.innerHTML = idx+1;
            nameEl.innerText = "Toque p/ add";
            nameEl.classList.remove('text-white');
            document.getElementById(`btn-clr-${idx+1}`).classList.add('hidden');
            updateState();
        }

        // --- LOAD FILES ---
        function checkLimit(addCount) {
            if(tracks.length + addCount > MAX_TRACKS) {
                notify(`Limite de ${MAX_TRACKS} arquivos!`, "error");
                return false;
            }
            return true;
        }

        document.getElementById('inp-music').onchange = function() {
            if(this.files.length) {
                if(!checkLimit(this.files.length)) return;
                Array.from(this.files).forEach(f => {
                    tracks.push({ 
                        id: Math.random().toString(36).slice(2), 
                        file: f, status: 'pending', msg: 'Aguardando', blob: null, originalName: f.name, vinhetaTime: 0
                    });
                });
                updateState();
            }
            this.value = '';
        };

        document.getElementById('inp-zip').onchange = async function() {
            const f = this.files[0];
            if(!f) return;
            notify("Lendo ZIP...");
            try {
                const z = new JSZip();
                const c = await z.loadAsync(f);
                let pending = [];
                const validExt = ['.mp3', '.wav', '.m4a', '.mp4', '.aac', '.flac', '.ogg', '.wma'];

                for(let k of Object.keys(c.files)) {
                    const entry = c.files[k];
                    const nameLower = entry.name.toLowerCase();
                    if(!entry.dir && !nameLower.includes('__macosx') && !nameLower.startsWith('.') && validExt.some(ext => nameLower.endsWith(ext))) {
                        pending.push(entry);
                    }
                }

                if(!checkLimit(pending.length)) return;
                
                for(let entry of pending) {
                    const b = await entry.async("blob");
                    const cleanName = entry.name.split('/').pop(); 
                    tracks.push({ 
                        id: Math.random().toString(36).slice(2), 
                        file: new File([b], cleanName, { type: "audio/mpeg" }), 
                        status: 'pending', msg: 'Do ZIP', blob: null, originalName: cleanName, vinhetaTime: 0
                    });
                }
                updateState();
            } catch(e) { notify("ZIP inv√°lido", "error"); }
            this.value = '';
        };

        window.remTrack = (id) => { 
            if(playingId === id) { document.getElementById('preview-audio').pause(); playingId = null; }
            tracks = tracks.filter(t => t.id !== id); 
            updateState(); 
        }

        // --- PLAYER ---
        const audioEl = document.getElementById('preview-audio');
        
        window.togglePlay = (id) => {
            const t = tracks.find(x => x.id === id);
            if(playingId === id) { 
                audioEl.pause(); playingId = null; 
            } else { 
                if(t.blob) { 
                    audioEl.src = URL.createObjectURL(t.blob); 
                    audioEl.play(); playingId = id; 
                } 
            }
            updateState();
        }

        window.jumpToVinheta = (id) => {
            const t = tracks.find(x => x.id === id);
            if(!t || !t.blob) return;

            if(playingId !== id) {
                audioEl.src = URL.createObjectURL(t.blob);
                playingId = id;
            }
            const targetTime = Math.max(0, t.vinhetaTime - 2);
            audioEl.currentTime = targetTime;
            audioEl.play();
            updateState();
            notify(`Preview em ${formatTime(targetTime)}`);
        }

        window.downloadSingle = (id) => {
            const t = tracks.find(x => x.id === id);
            if(t && t.blob) {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(t.blob);
                let safeName = t.originalName.replace(/\.[^/.]+$/, "");
                a.download = `${safeName} (SuitCds).wav`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }
        
        audioEl.onended = () => { playingId = null; updateState(); };

        function formatTime(sec) {
            const m = Math.floor(sec/60);
            const s = Math.floor(sec%60);
            return `${m}:${s<10?'0':''}${s}`;
        }
        
        // --- ALGORITMO INTELIGENTE V2 ---
        function analyzeDrop(buffer) {
            const sr = buffer.sampleRate;
            const data = buffer.getChannelData(0);
            const duration = buffer.duration;

            // Se for muito curta (< 1 min), bota no meio
            if (duration < 60) return duration / 2;

            // DEFINI√á√ÉO DA ZONA SEGURA:
            // 1. Ignora os primeiros 20% (Intro)
            // 2. Trava em 35s antes do fim (Para n√£o pegar o final)
            const safeStart = duration * 0.20;
            const safeEnd = Math.max(safeStart + 10, duration - 35);
            
            // Vamos procurar o ponto de menor energia dentro dessa zona segura
            const startSample = Math.floor(safeStart * sr);
            const endSample = Math.floor(safeEnd * sr);
            const step = sr * 2; // Analisa a cada 2 segs para performance

            let lowestEnergy = Infinity;
            // O padr√£o √© o meio da zona segura, caso n√£o ache nada bom
            let bestTime = safeStart + ((safeEnd - safeStart) / 2); 

            for (let i = startSample; i < endSample; i += step) {
                let sum = 0;
                // Amostra r√°pida (500 pontos)
                for (let j = 0; j < 500; j++) {
                    const idx = i + Math.floor(Math.random() * step);
                    if (idx < data.length) sum += Math.abs(data[idx]);
                }
                
                // Se a energia for menor que a atual, temos um novo candidato (break/parte calma)
                if (sum < lowestEnergy) {
                    lowestEnergy = sum;
                    bestTime = i / sr;
                }
            }

            return bestTime;
        }

        // --- UI ---
        function updateState() {
            const list = document.getElementById('list-container');
            const empty = document.getElementById('empty-msg');
            const btn = document.getElementById('btn-process');
            const activeV = vinhetaSlots.some(v=>v!==null);
            
            document.getElementById('slot-counter').innerText = `${vinhetaSlots.filter(x=>x).length}/2`;
            document.getElementById('track-counter').innerText = `${tracks.length}/${MAX_TRACKS}`;

            if(tracks.length > 0) {
                empty.classList.add('hidden'); list.classList.remove('hidden');
                
                list.innerHTML = tracks.map(t => {
                    const isPlaying = playingId === t.id;
                    let controls = '';

                    if(t.status === 'done') {
                        controls = `
                        <div class="flex items-center gap-2">
                            <button onclick="downloadSingle('${t.id}')" title="Baixar unit√°rio" class="w-8 h-8 rounded-lg bg-slate-800 text-slate-400 hover:text-white flex items-center justify-center border border-slate-700 transition-colors">
                                <i data-lucide="download" class="w-3.5 h-3.5"></i>
                            </button>
                            
                            <button onclick="jumpToVinheta('${t.id}')" class="px-2 py-1.5 rounded-lg bg-slate-800 text-sky-400 text-[10px] font-bold flex items-center gap-1 border border-slate-700 hover:bg-slate-700 active:scale-95 transition-all">
                                <i data-lucide="crosshair" class="w-3 h-3"></i> 
                                ${formatTime(t.vinhetaTime)}
                            </button>

                            <button onclick="togglePlay('${t.id}')" class="w-8 h-8 rounded-full ${isPlaying ? 'bg-white text-black' : 'bg-sky-600 text-white'} flex items-center justify-center transition-colors shadow-lg shadow-sky-900/30">
                                <i data-lucide="${isPlaying ? 'pause' : 'play'}" class="w-3 h-3 fill-current"></i>
                            </button>
                        </div>`;
                    } else if (t.status === 'processing') {
                         controls = `<i data-lucide="loader-2" class="w-4 h-4 text-sky-400 spin"></i>`;
                    } else if (t.status === 'error') {
                        controls = `<i data-lucide="alert-triangle" class="w-4 h-4 text-red-500"></i>`;
                    }

                    return `
                    <div class="card p-3 flex items-center justify-between group border-l-2 ${t.status==='done'?'border-l-sky-500':'border-l-transparent'}">
                        <div class="flex items-center gap-3 overflow-hidden flex-1">
                            <div class="min-w-0">
                                <div class="text-xs text-white truncate font-medium">${t.originalName}</div>
                                <div class="text-[10px] text-slate-500">${t.msg}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 pl-2">
                            ${controls}
                            <button onclick="remTrack('${t.id}')" class="p-2 text-slate-600 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            } else {
                empty.classList.remove('hidden'); list.classList.add('hidden');
            }

            const canProcess = activeV && tracks.length > 0;
            const hasSuccess = tracks.some(t => t.status === 'done');
            
            if(isProcessing) {
                btn.disabled = true; 
                btn.className = "flex-1 bg-slate-800 text-slate-400 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> CALCULANDO ZONAS...`;
            } else if(hasSuccess && !isProcessing && tracks.every(t=>t.status==='done' || t.status==='error')) {
                btn.className = "flex-1 bg-slate-900 text-slate-500 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerText = "FINALIZADO";
                btn.disabled = true;
                document.getElementById('btn-download').classList.remove('hidden');
            } else if(canProcess) {
                btn.disabled = false; 
                btn.className = "flex-1 bg-sky-600 text-white h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(2,132,199,0.3)] active:scale-95 transition-all hover:bg-sky-500";
                btn.innerHTML = `INICIAR MIXAGEM`;
                document.getElementById('btn-download').classList.add('hidden');
            } else {
                btn.disabled = true; 
                btn.className = "flex-1 bg-slate-900 text-slate-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerText = !activeV ? "FALTA VINHETA" : "ADD M√öSICAS";
                document.getElementById('btn-download').classList.add('hidden');
            }
            lucide.createIcons();
        }

        // --- PROCESSAMENTO CORE ---
        async function startProcessing() {
            if(isProcessing) return;
            initAudio();
            isProcessing = true; 
            updateState();

            const vinheta = vinhetaSlots.find(v => v !== null);
            if(!vinheta) { notify("Erro: Vinheta sumiu!", "error"); isProcessing=false; return; }

            const posMode = document.getElementById('sel-pos').value;
            const mixMode = document.getElementById('sel-mix').value;

            for(let i=0; i<tracks.length; i++) {
                if(tracks[i].status === 'done' || tracks[i].status === 'error') continue;

                tracks[i].status = 'processing'; 
                tracks[i].msg = 'Analisando Energia...';
                updateState();

                await new Promise(r => setTimeout(r, 20));

                try {
                    const ab = await tracks[i].file.arrayBuffer();
                    let trackBuffer;
                    try { trackBuffer = await audioCtx.decodeAudioData(ab); } catch(e) { throw new Error("Codec inv√°lido"); }

                    let startTime = 0;
                    const vDur = vinheta.duration;
                    const tDur = trackBuffer.duration;

                    // --- SELETOR DE L√ìGICA ---
                    if (posMode === 'balancedAI') {
                        // IA que busca calma, mas respeita as zonas
                        startTime = analyzeDrop(trackBuffer);
                        // Dupla verifica√ß√£o de seguran√ßa
                        if(startTime + vDur > tDur) startTime = tDur - vDur - 2;
                    } 
                    else if (posMode === 'safeZone') {
                        // Coloca em 70% da m√∫sica (geralmente seguro)
                        // Mas garante que n√£o entre nos √∫ltimos 30s
                        let target = tDur * 0.70;
                        if (target > tDur - 35) target = tDur - 35;
                        startTime = target;
                    } 
                    else if (posMode === 'intro') {
                        startTime = Math.min(15, tDur / 2);
                    } 
                    else {
                        startTime = 0;
                    }

                    tracks[i].vinhetaTime = startTime;

                    const offlineCtx = new OfflineAudioContext(2, trackBuffer.length, trackBuffer.sampleRate);
                    const musicSrc = offlineCtx.createBufferSource(); musicSrc.buffer = trackBuffer;
                    const vinhetaSrc = offlineCtx.createBufferSource(); vinhetaSrc.buffer = vinheta.buffer;
                    const musicGain = offlineCtx.createGain();
                    const vinhetaGain = offlineCtx.createGain();

                    if (mixMode === 'ducking') {
                        musicGain.gain.setValueAtTime(1, startTime);
                        musicGain.gain.linearRampToValueAtTime(0.3, startTime + 0.2);
                        musicGain.gain.setValueAtTime(0.3, startTime + vDur - 0.2);
                        musicGain.gain.linearRampToValueAtTime(1, startTime + vDur);
                    } else if (mixMode === 'cut') {
                        musicGain.gain.setValueAtTime(1, startTime);
                        musicGain.gain.linearRampToValueAtTime(0, startTime + 0.05);
                        musicGain.gain.setValueAtTime(0, startTime + vDur - 0.05);
                        musicGain.gain.linearRampToValueAtTime(1, startTime + vDur);
                    } else {
                        vinhetaGain.gain.value = 1.2;
                    }

                    musicSrc.connect(musicGain); musicGain.connect(offlineCtx.destination);
                    vinhetaSrc.connect(vinhetaGain); vinhetaGain.connect(offlineCtx.destination);
                    musicSrc.start(0); vinhetaSrc.start(startTime);

                    tracks[i].msg = 'Renderizando...'; updateState();
                    const renderedBuffer = await offlineCtx.startRendering();
                    tracks[i].blob = bufferToWave(renderedBuffer, renderedBuffer.length);
                    tracks[i].status = 'done';
                    tracks[i].msg = 'Pronto';
                    
                    tracks[i].file = null; // Limpeza RAM

                } catch(e) {
                    tracks[i].status = 'error';
                    tracks[i].msg = 'Erro';
                    console.error(e);
                }
            }

            isProcessing = false;
            updateState();
            if(tracks.some(t => t.status === 'done')) notify("Conclu√≠do! Pode baixar.", "success");
        }

        // --- WAV ENCODER ---
        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels, length = len * numOfChan * 2 + 44, buffer = new ArrayBuffer(length), view = new DataView(buffer), channels = [], i, sample, offset = 0, pos = 0;
            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }

            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157); setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan); setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan); setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - pos - 4);
            for(i=0; i<numOfChan; i++) channels.push(abuffer.getChannelData(i));
            while(pos < length) {
                for(i=0; i<numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][offset])); 
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0; 
                    view.setInt16(pos, sample, true); pos += 2;
                }
                offset++;
            }
            return new Blob([buffer], { type: "audio/wav" });
        }

        // --- DOWNLOAD ZIP BLINDADO ---
        async function downloadZip(e) {
            if(e) e.preventDefault();
            
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> GERANDO ZIP...`;
                lucide.createIcons();

                const zip = new JSZip();
                const folder = zip.folder("SuitCds_Mixes");
                let count = 0;

                tracks.forEach((t, idx) => {
                    if (t.status === 'done' && t.blob) {
                        let safeName = t.originalName.replace(/\.[^/.]+$/, "");
                        let fileName = `${String(idx+1).padStart(2, '0')} - ${safeName} (SuitCds).wav`;
                        folder.file(fileName, t.blob);
                        count++;
                    }
                });

                if(count === 0) {
                    notify("Nada para baixar.", "error");
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }

                const content = await zip.generateAsync({
                    type: "blob", 
                    compression: "STORE",
                    streamFiles: true 
                }, (metadata) => {
                    btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> ${metadata.percent.toFixed(0)}%`;
                });

                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = "SuitCds_V33_Pack.zip";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                notify("Download Iniciado!", "success");

            } catch(e) {
                console.error(e);
                notify("Mem√≥ria cheia. Use o bot√£o individual.", "error");
                btn.innerHTML = "ERRO MEM√ìRIA";
            } finally {
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    lucide.createIcons();
                }, 2000);
            }
        }
    </script>
</body>
</html>

