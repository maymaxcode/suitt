<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SuitCds V29 Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* BASE & THEME */
        body { 
            background-color: #050505; 
            color: #e4e4e7; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, sans-serif;
            overflow-x: hidden;
        }

        /* NEVE */
        .snowflake {
            position: fixed; top: -10px; background: rgba(255,255,255,0.2);
            border-radius: 50%; pointer-events: none; z-index: 0; animation: fall linear infinite;
        }
        @keyframes fall { to { transform: translateY(110vh); } }

        /* INPUT FANTASMA */
        .phantom-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; z-index: 20; cursor: pointer;
        }

        /* GLASS STYLE */
        .glass { 
            background: rgba(20, 20, 25, 0.85); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card {
            @apply glass; border-radius: 16px; position: relative; z-index: 10; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:active { transform: scale(0.98); background: rgba(40, 40, 45, 0.9); }
        
        .slot-filled { border-color: #22c55e; background: rgba(34, 197, 94, 0.05); }
        
        /* PLAYER SLIDER */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #fff; cursor: pointer; margin-top: -5px; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; cursor: pointer; background: #3f3f46; border-radius: 2px;
        }
        
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* TOAST */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #fff; color: #000; padding: 12px 24px; border-radius: 50px;
            font-weight: 700; font-size: 13px; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 100;
            display: flex; align-items: center; gap: 8px; width: max-content;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen pb-44 selection:bg-green-500/30">

    <audio id="preview-audio" playsinline webkit-playsinline></audio>

    <div id="toast"><i data-lucide="info" class="w-4 h-4"></i> <span id="toast-msg">Info</span></div>

    <!-- HEADER -->
    <header class="pt-8 pb-6 px-6 border-b border-white/5 bg-black/60 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-emerald-800 text-white rounded-xl flex items-center justify-center shadow-lg shadow-green-900/40">
                    <i data-lucide="music-2" class="w-5 h-5 fill-current"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white leading-tight">SuitCds</h1>
                    <p class="text-[10px] text-zinc-500 font-bold tracking-[0.2em] uppercase">V29 STABLE</p>
                </div>
            </div>
            <div class="px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800 text-[10px] font-mono text-zinc-500">
                LITE
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-5 space-y-8 relative z-10">

        <!-- 1. VINHETAS -->
        <section>
            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-4 h-4 rounded bg-zinc-800 text-white flex items-center justify-center text-[10px]">1</span> 
                    Vinhetas
                </h2>
                <span id="slot-counter" class="text-[10px] text-zinc-600 font-mono bg-zinc-900 px-2 py-0.5 rounded">0/2</span>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="card h-24 flex flex-col items-center justify-center gap-2 group" id="slot-1">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(0, this)">
                    <div id="icon-1" class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 group-hover:border-green-500/50 transition-colors">1</div>
                    <span id="name-1" class="text-[11px] font-medium text-zinc-400 truncate w-full px-3 text-center">Toque para adicionar</span>
                    <button onclick="clearVinheta(0, event)" id="btn-clr-1" class="hidden absolute top-1 right-1 p-2 text-zinc-500 hover:text-red-400 z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <div class="card h-24 flex flex-col items-center justify-center gap-2 group" id="slot-2">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(1, this)">
                    <div id="icon-2" class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 group-hover:border-green-500/50 transition-colors">2</div>
                    <span id="name-2" class="text-[11px] font-medium text-zinc-400 truncate w-full px-3 text-center">Toque para adicionar</span>
                    <button onclick="clearVinheta(1, event)" id="btn-clr-2" class="hidden absolute top-1 right-1 p-2 text-zinc-500 hover:text-red-400 z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            </div>
        </section>

        <!-- 2. SETUP -->
        <section>
            <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 px-1 flex items-center gap-2">
                <span class="w-4 h-4 rounded bg-zinc-800 text-white flex items-center justify-center text-[10px]">2</span> 
                Painel
            </h2>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="card p-3 relative overflow-hidden">
                    <label class="text-[9px] text-zinc-500 font-bold uppercase block mb-1">Posi√ß√£o</label>
                    <select id="sel-pos" class="w-full bg-transparent text-xs text-white outline-none cursor-pointer appearance-none relative z-10 font-medium">
                        <option value="safeEnd">üõ°Ô∏è Fim (Safe -15s)</option>
                        <option value="start">‚ñ∂Ô∏è In√≠cio (0:00)</option>
                        <option value="intro">‚è≥ Intro (0:15)</option>
                        <option value="middle">üìè Meio (50%)</option>
                    </select>
                    <i data-lucide="chevron-down" class="w-3 h-3 text-zinc-600 absolute right-3 bottom-3 z-0"></i>
                </div>
                <div class="card p-3 relative overflow-hidden">
                    <label class="text-[9px] text-zinc-500 font-bold uppercase block mb-1">Estilo</label>
                    <select id="sel-mix" class="w-full bg-transparent text-xs text-white outline-none cursor-pointer appearance-none relative z-10 font-medium">
                        <option value="ducking">üìª R√°dio (Baixa Vol)</option>
                        <option value="overlay">üî• Rave (Por Cima)</option>
                        <option value="cut">‚úÇÔ∏è Seco (Corta Som)</option>
                    </select>
                    <i data-lucide="chevron-down" class="w-3 h-3 text-zinc-600 absolute right-3 bottom-3 z-0"></i>
                </div>
            </div>
        </section>

        <!-- 3. PLAYLIST -->
        <section>
            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-4 h-4 rounded bg-zinc-800 text-white flex items-center justify-center text-[10px]">3</span> 
                    Arquivos
                </h2>
                <span id="track-counter" class="text-[10px] text-zinc-600 font-mono bg-zinc-900 px-2 py-0.5 rounded">0/50</span>
            </div>

            <div class="flex gap-3 mb-4">
                <div class="card flex-1 h-14 flex flex-row items-center justify-center gap-2 active:bg-zinc-800 cursor-pointer relative overflow-hidden hover:border-zinc-600 transition-colors">
                    <input type="file" class="phantom-input" id="inp-music" multiple accept="*">
                    <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center">
                        <i data-lucide="music" class="w-4 h-4 text-green-400"></i>
                    </div>
                    <span class="text-[10px] font-bold text-zinc-300">SELECIONAR</span>
                </div>
                <div class="card flex-1 h-14 flex flex-row items-center justify-center gap-2 active:bg-zinc-800 cursor-pointer relative overflow-hidden hover:border-zinc-600 transition-colors">
                    <input type="file" class="phantom-input" id="inp-zip" accept="*">
                    <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center">
                        <i data-lucide="archive" class="w-4 h-4 text-emerald-400"></i>
                    </div>
                    <span class="text-[10px] font-bold text-zinc-300">ABRIR ZIP</span>
                </div>
            </div>

            <!-- LISTA -->
            <div id="list-container" class="hidden space-y-2 pb-4"></div>
            
            <div id="empty-msg" class="text-center py-12 border border-dashed border-zinc-800 rounded-2xl">
                <div class="w-12 h-12 rounded-full bg-zinc-900 mx-auto flex items-center justify-center mb-3">
                    <i data-lucide="folder-search" class="w-5 h-5 text-zinc-600"></i>
                </div>
                <p class="text-xs text-zinc-500 font-medium">Nenhum arquivo</p>
            </div>
        </section>

    </main>

    <!-- FOOTER -->
    <footer class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-xl border-t border-white/5 p-5 z-50 pb-8">
        <div class="max-w-xl mx-auto flex gap-3">
            <button id="btn-process" onclick="startProcessing()" disabled class="flex-1 bg-zinc-900 text-zinc-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-50">
                <span>AGUARDANDO...</span>
            </button>
            <button id="btn-download" type="button" onclick="downloadZip(event)" class="hidden w-[45%] bg-white text-black h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-[0_0_20px_rgba(255,255,255,0.15)] hover:bg-zinc-200">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span>BAIXAR ZIP</span>
            </button>
        </div>
    </footer>

    <script>
        // --- EFEITO NEVE ---
        function createSnow() {
            const container = document.body;
            for(let i=0; i<15; i++) {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                flake.style.width = Math.random() * 2 + 1 + 'px';
                flake.style.height = flake.style.width;
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.opacity = Math.random() * 0.3 + 0.1;
                flake.style.animationDuration = Math.random() * 10 + 10 + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(flake);
            }
        }
        createSnow();

        // --- GLOBAL ---
        let audioCtx;
        let vinhetaSlots = [null, null];
        let tracks = [];
        let isProcessing = false;
        let playingId = null;
        const MAX_TRACKS = 50;

        lucide.createIcons();

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        document.body.addEventListener('click', () => initAudio(), {once:true});

        function notify(msg, type='info') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.color = type === 'error' ? '#ef4444' : '#000';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- VINHETA ---
        async function loadVinheta(idx, input) {
            const file = input.files[0];
            if(!file) return;
            initAudio();
            
            const nameEl = document.getElementById(`name-${idx+1}`);
            const iconEl = document.getElementById(`icon-${idx+1}`);
            nameEl.innerText = "Lendo...";
            
            try {
                const ab = await file.arrayBuffer();
                const buf = await audioCtx.decodeAudioData(ab);
                vinhetaSlots[idx] = { buffer: buf, duration: buf.duration, name: file.name };
                
                document.getElementById(`slot-${idx+1}`).classList.add('slot-filled');
                iconEl.className = "w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center shadow-lg shadow-green-500/30";
                iconEl.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                nameEl.innerText = file.name;
                nameEl.classList.add('text-white');
                document.getElementById(`btn-clr-${idx+1}`).classList.remove('hidden');
                lucide.createIcons();
                updateState();
            } catch(e) {
                notify("Erro: Arquivo de √°udio inv√°lido", "error");
                nameEl.innerText = "Erro";
            }
            input.value = ''; 
        }

        function clearVinheta(idx, e) {
            e.preventDefault(); e.stopPropagation();
            vinhetaSlots[idx] = null;
            document.getElementById(`slot-${idx+1}`).classList.remove('slot-filled');
            const iconEl = document.getElementById(`icon-${idx+1}`);
            const nameEl = document.getElementById(`name-${idx+1}`);
            iconEl.className = "w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 transition-colors";
            iconEl.innerHTML = idx+1;
            nameEl.innerText = "Toque para adicionar";
            nameEl.classList.remove('text-white');
            document.getElementById(`btn-clr-${idx+1}`).classList.add('hidden');
            updateState();
        }

        // --- LOAD M√öSICAS ---
        function checkLimit(addCount) {
            if(tracks.length + addCount > MAX_TRACKS) {
                notify(`Limite de ${MAX_TRACKS} arquivos!`, "error");
                return false;
            }
            return true;
        }

        document.getElementById('inp-music').onchange = function() {
            if(this.files.length) {
                if(!checkLimit(this.files.length)) return;
                Array.from(this.files).forEach(f => {
                    tracks.push({ 
                        id: Math.random().toString(36).slice(2), 
                        file: f, status: 'pending', msg: 'Aguardando', blob: null, originalName: f.name, vinhetaTime: 0
                    });
                });
                updateState();
            }
            this.value = '';
        };

        // --- ZIP INPUT ---
        document.getElementById('inp-zip').onchange = async function() {
            const f = this.files[0];
            if(!f) return;
            notify("Lendo ZIP...");
            try {
                const z = new JSZip();
                const c = await z.loadAsync(f);
                let pending = [];
                const validExt = ['.mp3', '.wav', '.m4a', '.mp4', '.aac', '.flac', '.ogg', '.wma'];

                for(let k of Object.keys(c.files)) {
                    const entry = c.files[k];
                    const nameLower = entry.name.toLowerCase();
                    if(!entry.dir && !nameLower.includes('__macosx') && !nameLower.startsWith('.') && validExt.some(ext => nameLower.endsWith(ext))) {
                        pending.push(entry);
                    }
                }

                if(!checkLimit(pending.length)) return;
                
                for(let entry of pending) {
                    const b = await entry.async("blob");
                    const cleanName = entry.name.split('/').pop(); 
                    tracks.push({ 
                        id: Math.random().toString(36).slice(2), 
                        file: new File([b], cleanName, { type: "audio/mpeg" }), 
                        status: 'pending', msg: 'Do ZIP', blob: null, originalName: cleanName, vinhetaTime: 0
                    });
                }
                updateState();
            } catch(e) { notify("ZIP inv√°lido", "error"); }
            this.value = '';
        };

        window.remTrack = (id) => { 
            if(playingId === id) { document.getElementById('preview-audio').pause(); playingId = null; }
            tracks = tracks.filter(t => t.id !== id); 
            updateState(); 
        }

        // --- PLAYER ---
        const audioEl = document.getElementById('preview-audio');
        
        window.togglePlay = (id) => {
            const t = tracks.find(x => x.id === id);
            if(playingId === id) { 
                audioEl.pause(); playingId = null; 
            } else { 
                if(t.blob) { 
                    audioEl.src = URL.createObjectURL(t.blob); 
                    audioEl.play(); playingId = id; 
                } 
            }
            updateState();
        }

        // *** NOVIDADE: PULAR PARA VINHETA ***
        window.jumpToVinheta = (id) => {
            const t = tracks.find(x => x.id === id);
            if(!t || !t.blob) return;

            // Se n√£o estiver tocando esta m√∫sica, d√° play primeiro
            if(playingId !== id) {
                audioEl.src = URL.createObjectURL(t.blob);
                playingId = id;
            }
            
            // Pula para 2 segundos antes da vinheta
            const targetTime = Math.max(0, t.vinhetaTime - 2);
            audioEl.currentTime = targetTime;
            audioEl.play();
            updateState();
            notify(`Pulo para ${formatTime(targetTime)}`);
        }
        
        audioEl.onended = () => { playingId = null; updateState(); };

        function formatTime(sec) {
            const m = Math.floor(sec/60);
            const s = Math.floor(sec%60);
            return `${m}:${s<10?'0':''}${s}`;
        }
        
        // --- UI RENDER ---
        function updateState() {
            const list = document.getElementById('list-container');
            const empty = document.getElementById('empty-msg');
            const btn = document.getElementById('btn-process');
            const activeV = vinhetaSlots.some(v=>v!==null);
            
            document.getElementById('slot-counter').innerText = `${vinhetaSlots.filter(x=>x).length}/2`;
            document.getElementById('track-counter').innerText = `${tracks.length}/${MAX_TRACKS}`;

            if(tracks.length > 0) {
                empty.classList.add('hidden'); list.classList.remove('hidden');
                
                list.innerHTML = tracks.map(t => {
                    const isPlaying = playingId === t.id;
                    let controls = '';

                    // Controles quando pronto
                    if(t.status === 'done') {
                        controls = `
                        <div class="flex items-center gap-2">
                            <button onclick="jumpToVinheta('${t.id}')" class="px-2 py-1.5 rounded-lg bg-zinc-800 text-green-400 text-[10px] font-bold flex items-center gap-1 border border-zinc-700 hover:bg-zinc-700 active:scale-95 transition-all">
                                <i data-lucide="crosshair" class="w-3 h-3"></i> 
                                ${formatTime(t.vinhetaTime)}
                            </button>
                            <button onclick="togglePlay('${t.id}')" class="w-8 h-8 rounded-full ${isPlaying ? 'bg-white text-black' : 'bg-zinc-800 text-green-400'} flex items-center justify-center transition-colors">
                                <i data-lucide="${isPlaying ? 'pause' : 'play'}" class="w-3 h-3 fill-current"></i>
                            </button>
                        </div>`;
                    } else if (t.status === 'processing') {
                         controls = `<i data-lucide="loader-2" class="w-4 h-4 text-yellow-500 spin"></i>`;
                    } else if (t.status === 'error') {
                        controls = `<i data-lucide="alert-triangle" class="w-4 h-4 text-red-500"></i>`;
                    }

                    return `
                    <div class="card p-3 flex items-center justify-between group">
                        <div class="flex items-center gap-3 overflow-hidden flex-1">
                            <div class="min-w-0">
                                <div class="text-xs text-white truncate font-medium">${t.originalName}</div>
                                <div class="text-[10px] text-zinc-500">${t.msg}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 pl-2">
                            ${controls}
                            <button onclick="remTrack('${t.id}')" class="p-2 text-zinc-600 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            } else {
                empty.classList.remove('hidden'); list.classList.add('hidden');
            }

            const canProcess = activeV && tracks.length > 0;
            const hasSuccess = tracks.some(t => t.status === 'done');
            
            if(isProcessing) {
                btn.disabled = true; 
                btn.className = "flex-1 bg-zinc-800 text-zinc-400 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> PROCESSANDO...`;
            } else if(hasSuccess && !isProcessing && tracks.every(t=>t.status==='done' || t.status==='error')) {
                btn.className = "flex-1 bg-zinc-900 text-zinc-500 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerText = "CONCLU√çDO";
                btn.disabled = true;
                document.getElementById('btn-download').classList.remove('hidden');
            } else if(canProcess) {
                btn.disabled = false; 
                btn.className = "flex-1 bg-green-600 text-white h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(34,197,94,0.3)] active:scale-95 transition-all";
                btn.innerHTML = `INICIAR MIXAGEM`;
                document.getElementById('btn-download').classList.add('hidden');
            } else {
                btn.disabled = true; 
                btn.className = "flex-1 bg-zinc-900 text-zinc-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerText = !activeV ? "FALTA VINHETA" : "ADD M√öSICAS";
                document.getElementById('btn-download').classList.add('hidden');
            }
            lucide.createIcons();
        }

        // --- PROCESSAMENTO DE √ÅUDIO ---
        async function startProcessing() {
            if(isProcessing) return;
            initAudio();
            isProcessing = true; 
            updateState();

            const vinheta = vinhetaSlots.find(v => v !== null);
            if(!vinheta) { notify("Erro: Vinheta sumiu!", "error"); isProcessing=false; return; }

            const posMode = document.getElementById('sel-pos').value;
            const mixMode = document.getElementById('sel-mix').value;

            for(let i=0; i<tracks.length; i++) {
                if(tracks[i].status === 'done' || tracks[i].status === 'error') continue;

                tracks[i].status = 'processing'; 
                tracks[i].msg = 'Lendo...';
                updateState();

                await new Promise(r => setTimeout(r, 20));

                try {
                    const ab = await tracks[i].file.arrayBuffer();
                    let trackBuffer;
                    try { trackBuffer = await audioCtx.decodeAudioData(ab); } catch(e) { throw new Error("Codec inv√°lido"); }

                    let startTime = 0;
                    const vDur = vinheta.duration;
                    const tDur = trackBuffer.duration;

                    if (posMode === 'safeEnd') startTime = Math.max(0, tDur - vDur - 15);
                    else if (posMode === 'intro') startTime = Math.min(15, tDur / 2);
                    else if (posMode === 'middle') startTime = (tDur / 2) - (vDur / 2);
                    
                    // *** SALVA O TEMPO DA VINHETA PARA O BOT√ÉO DE PREVIEW ***
                    tracks[i].vinhetaTime = startTime;

                    const offlineCtx = new OfflineAudioContext(2, trackBuffer.length, trackBuffer.sampleRate);
                    const musicSrc = offlineCtx.createBufferSource(); musicSrc.buffer = trackBuffer;
                    const vinhetaSrc = offlineCtx.createBufferSource(); vinhetaSrc.buffer = vinheta.buffer;
                    const musicGain = offlineCtx.createGain();
                    const vinhetaGain = offlineCtx.createGain();

                    if (mixMode === 'ducking') {
                        musicGain.gain.setValueAtTime(1, startTime);
                        musicGain.gain.linearRampToValueAtTime(0.3, startTime + 0.2);
                        musicGain.gain.setValueAtTime(0.3, startTime + vDur - 0.2);
                        musicGain.gain.linearRampToValueAtTime(1, startTime + vDur);
                    } else if (mixMode === 'cut') {
                        musicGain.gain.setValueAtTime(1, startTime);
                        musicGain.gain.linearRampToValueAtTime(0, startTime + 0.05);
                        musicGain.gain.setValueAtTime(0, startTime + vDur - 0.05);
                        musicGain.gain.linearRampToValueAtTime(1, startTime + vDur);
                    } else {
                        vinhetaGain.gain.value = 1.2;
                    }

                    musicSrc.connect(musicGain); musicGain.connect(offlineCtx.destination);
                    vinhetaSrc.connect(vinhetaGain); vinhetaGain.connect(offlineCtx.destination);
                    musicSrc.start(0); vinhetaSrc.start(startTime);

                    tracks[i].msg = 'Mixando...'; updateState();
                    const renderedBuffer = await offlineCtx.startRendering();
                    tracks[i].blob = bufferToWave(renderedBuffer, renderedBuffer.length);
                    tracks[i].status = 'done';
                    tracks[i].msg = 'Pronto';
                    tracks[i].file = null; // Limpa RAM

                } catch(e) {
                    tracks[i].status = 'error';
                    tracks[i].msg = 'Erro';
                }
            }

            isProcessing = false;
            updateState();
            if(tracks.some(t => t.status === 'done')) notify("Conclu√≠do! Pode baixar.", "success");
        }

        // --- WAV ENCODER ---
        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels, length = len * numOfChan * 2 + 44, buffer = new ArrayBuffer(length), view = new DataView(buffer), channels = [], i, sample, offset = 0, pos = 0;
            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }

            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157); setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan); setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan); setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - pos - 4);
            for(i=0; i<numOfChan; i++) channels.push(abuffer.getChannelData(i));
            while(pos < length) {
                for(i=0; i<numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][offset])); 
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0; 
                    view.setInt16(pos, sample, true); pos += 2;
                }
                offset++;
            }
            return new Blob([buffer], { type: "audio/wav" });
        }

        // --- DOWNLOAD ZIP (CORRE√á√ÉO DE CRASH) ---
        async function downloadZip(e) {
            if(e) e.preventDefault(); // Impede reload do form/bot√£o
            
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> GERANDO...`;
                lucide.createIcons();

                const zip = new JSZip();
                const folder = zip.folder("SuitCds_Mixes");
                let count = 0;

                tracks.forEach((t, idx) => {
                    if (t.status === 'done' && t.blob) {
                        let safeName = t.originalName.replace(/\.[^/.]+$/, "");
                        let fileName = `${String(idx+1).padStart(2, '0')} - ${safeName} (SuitCds).wav`;
                        folder.file(fileName, t.blob);
                        count++;
                    }
                });

                if(count === 0) {
                    notify("Nada para baixar.", "error");
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }

                // *** CRITICAL FIX: STORE MODE ***
                // "STORE" n√£o tenta comprimir o √°udio (que j√° √© ruim de comprimir).
                // Isso economiza 90% da RAM e CPU, evitando o reload da p√°gina.
                const content = await zip.generateAsync({
                    type: "blob", 
                    compression: "STORE" 
                }, (metadata) => {
                    btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> ${metadata.percent.toFixed(0)}%`;
                });

                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = "SuitCds_Pacote.zip";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                notify("Download Iniciado!", "success");

            } catch(e) {
                console.error(e);
                notify("Erro de mem√≥ria. Baixe menos m√∫sicas.", "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>

