import React, { useState, useRef, useEffect } from 'react';
import { 
  Upload, Play, Pause, Download, Music, Radio, 
  Zap, Loader2, X, Settings2, FileVideo, 
  Volume2, Disc, Archive, Activity, Sliders, Layers
} from 'lucide-react';

// --- UTILIT√ÅRIOS: Encoder WAV (Qualidade de Est√∫dio 16-bit) ---
const bufferToWave = (abuffer, len) => {
  let numOfChan = abuffer.numberOfChannels,
      length = len * numOfChan * 2 + 44,
      buffer = new ArrayBuffer(length),
      view = new DataView(buffer),
      channels = [], i, sample,
      offset = 0,
      pos = 0;

  setUint32(0x46464952); // "RIFF"
  setUint32(length - 8); 
  setUint32(0x45564157); // "WAVE"
  setUint32(0x20746d66); // "fmt "
  setUint32(16); 
  setUint16(1); 
  setUint16(numOfChan);
  setUint32(abuffer.sampleRate);
  setUint32(abuffer.sampleRate * 2 * numOfChan);
  setUint16(numOfChan * 2);
  setUint16(16); 
  setUint32(0x61746164); // "data"
  setUint32(length - pos - 4);

  for(i = 0; i < abuffer.numberOfChannels; i++)
    channels.push(abuffer.getChannelData(i));

  while(pos < len) {
    for(i = 0; i < numOfChan; i++) {
      sample = Math.max(-1, Math.min(1, channels[i][pos]));
      sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0;
      view.setInt16(44 + offset, sample, true);
      offset += 2;
    }
    pos++;
  }

  return new Blob([buffer], { type: "audio/wav" });

  function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
  function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
};

// --- GERADOR DE EFEITOS SONOROS (SINTETIZADOR WEB AUDIO) ---
const generateSFX = async (ctx, type) => {
    const sampleRate = ctx.sampleRate;
    if (type === 'none') return null;

    // Airhorn (Buzina Reggae)
    if (type === 'airhorn') {
        const duration = 1.5;
        const buffer = ctx.createBuffer(2, sampleRate * duration, sampleRate);
        for (let channel = 0; channel < 2; channel++) {
            const data = buffer.getChannelData(channel);
            for (let i = 0; i < data.length; i++) {
                const t = i / sampleRate;
                const freq = 400; 
                const signal = (Math.sin(t * freq * 6.28) + Math.sin(t * (freq + 5) * 6.28)) * 0.5;
                const envelope = Math.max(0, 1 - (t / duration));
                data[i] = (signal > 0 ? 0.5 : -0.5) * envelope * 0.4;
            }
        }
        return buffer;
    }

    // Impacto (Boom Cinematogr√°fico)
    if (type === 'impact') {
        const duration = 2.0;
        const buffer = ctx.createBuffer(2, sampleRate * duration, sampleRate);
        for (let channel = 0; channel < 2; channel++) {
            const data = buffer.getChannelData(channel);
            for (let i = 0; i < data.length; i++) {
                const t = i / sampleRate;
                const noise = (Math.random() * 2 - 1);
                const sine = Math.sin(t * 50 * 6.28); 
                const envelope = Math.exp(-t * 3);
                data[i] = (noise * 0.3 + sine * 0.7) * envelope;
            }
        }
        return buffer;
    }

    return null;
};

export default function App() {
  // --- ESTADOS ---
  const [vinhetaBuffer, setVinhetaBuffer] = useState(null);
  const [vinhetaName, setVinhetaName] = useState(null);
  const [isVideoVinheta, setIsVideoVinheta] = useState(false);
  const [tracks, setTracks] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [isZipping, setIsZipping] = useState(false);
  const [audioContext, setAudioContext] = useState(null);
  const [jsZipLoaded, setJsZipLoaded] = useState(false);
  
  // --- CONFIGURA√á√ïES DO DJ ---
  const [detectMode, setDetectMode] = useState('smart30'); 
  const [mixMode, setMixMode] = useState('ducking'); 
  const [sfxMode, setSfxMode] = useState('none'); 
  
  // --- PLAYER ---
  const [playingId, setPlayingId] = useState(null);
  const audioPlayerRef = useRef(null);

  // Inicializa√ß√£o
  useEffect(() => {
    if (window.JSZip) { setJsZipLoaded(true); return; }
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
    script.onload = () => setJsZipLoaded(true);
    document.body.appendChild(script);
  }, []);

  useEffect(() => {
    const initAudio = () => {
      if (!audioContext) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        setAudioContext(new AudioContext());
      }
    };
    window.addEventListener('click', initAudio, { once: true });
    window.addEventListener('touchstart', initAudio, { once: true });
  }, [audioContext]);

  // --- L√ìGICA DE √ÅUDIO ---

  const findBestSpot = (musicBuffer, vinhetaDuration) => {
    if (detectMode === 'start') return 0;

    const sampleRate = musicBuffer.sampleRate;
    let maxSearchTime = 30; // Padr√£o 30s
    if (detectMode === 'smart60') maxSearchTime = 60;
    if (detectMode === 'calmest') maxSearchTime = musicBuffer.duration; // M√∫sica inteira

    const rawData = musicBuffer.getChannelData(0);
    const searchSamples = Math.min(rawData.length, sampleRate * maxSearchTime);
    const vinhetaSamples = Math.ceil(vinhetaDuration * sampleRate);
    
    const step = detectMode === 'calmest' ? Math.floor(sampleRate * 1.0) : Math.floor(sampleRate * 0.5);

    let minEnergy = Infinity;
    let bestStartSample = 0;

    for (let i = 0; i < searchSamples - vinhetaSamples; i += step) {
      let sumSquares = 0;
      const analyzeLimit = 500; 
      for (let j = 0; j < analyzeLimit; j++) {
        const idx = Math.floor(i + (j * (vinhetaSamples / analyzeLimit)));
        if (idx < rawData.length) {
            const val = rawData[idx];
            sumSquares += val * val;
        }
      }
      
      const rms = Math.sqrt(sumSquares / analyzeLimit);
      
      if (rms < minEnergy) {
        minEnergy = rms;
        bestStartSample = i;
      }
    }
    return bestStartSample / sampleRate;
  };

  const processTrack = async (track) => {
    let ctx = audioContext;
    if (!ctx) {
         ctx = new (window.AudioContext || window.webkitAudioContext)();
         setAudioContext(ctx);
    }

    try {
      const arrayBuffer = await track.file.arrayBuffer();
      const musicBuffer = await ctx.decodeAudioData(arrayBuffer);
      
      // 1. Gera SFX se necess√°rio
      const sfxBuffer = await generateSFX(ctx, sfxMode);
      const sfxDuration = sfxBuffer ? sfxBuffer.duration : 0;

      // 2. Calcula Posi√ß√£o
      const totalInsertDuration = vinhetaBuffer.duration + (sfxDuration > 0 ? sfxDuration * 0.5 : 0);
      const startTime = findBestSpot(musicBuffer, totalInsertDuration);

      // 3. Renderiza√ß√£o
      const offlineCtx = new OfflineAudioContext(2, musicBuffer.length, musicBuffer.sampleRate);

      // --- TRILHA 1: M√öSICA ---
      const musicSource = offlineCtx.createBufferSource();
      musicSource.buffer = musicBuffer;
      const musicGain = offlineCtx.createGain();
      
      const fadeTime = 0.3; 
      const insertEnd = startTime + totalInsertDuration;

      musicGain.gain.setValueAtTime(1, 0);

      if (mixMode === 'ducking') {
        musicGain.gain.setValueAtTime(1, startTime);
        musicGain.gain.linearRampToValueAtTime(0.25, startTime + fadeTime);
        musicGain.gain.setValueAtTime(0.25, insertEnd - fadeTime);
        musicGain.gain.linearRampToValueAtTime(1, insertEnd);
      } else if (mixMode === 'cut') {
        musicGain.gain.setValueAtTime(1, startTime);
        musicGain.gain.linearRampToValueAtTime(0, startTime + 0.05);
        musicGain.gain.setValueAtTime(0, insertEnd - 0.05);
        musicGain.gain.linearRampToValueAtTime(1, insertEnd);
      }

      musicSource.connect(musicGain);
      musicGain.connect(offlineCtx.destination);
      musicSource.start(0);

      // --- TRILHA 2: SFX (Opcional) ---
      if (sfxBuffer) {
          const sfxSource = offlineCtx.createBufferSource();
          sfxSource.buffer = sfxBuffer;
          const sfxGain = offlineCtx.createGain();
          sfxGain.gain.value = 0.8; 
          sfxSource.connect(sfxGain);
          sfxGain.connect(offlineCtx.destination);
          sfxSource.start(startTime);
      }

      // --- TRILHA 3: VINHETA ---
      const vinhetaSource = offlineCtx.createBufferSource();
      vinhetaSource.buffer = vinhetaBuffer;
      const vinhetaGain = offlineCtx.createGain();
      vinhetaGain.gain.value = mixMode === 'overlay' ? 1.3 : 1.1; 
      
      vinhetaSource.connect(vinhetaGain);
      vinhetaGain.connect(offlineCtx.destination);
      
      const vinhetaDelay = sfxBuffer ? 0.5 : 0;
      vinhetaSource.start(startTime + vinhetaDelay);

      const renderedBuffer = await offlineCtx.startRendering();
      const wavBlob = bufferToWave(renderedBuffer, renderedBuffer.length);

      return {
        ...track,
        status: 'done',
        blob: wavBlob,
        message: `Mixado em ${startTime.toFixed(0)}s`
      };

    } catch (error) {
      console.error(error);
      return { ...track, status: 'error', message: 'Erro DRM/Formato' };
    }
  };

  // --- UI & HANDLERS ---
  const handleVinhetaUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
        const ctx = audioContext || new (window.AudioContext || window.webkitAudioContext)();
        if(!audioContext) setAudioContext(ctx);
        const ab = await file.arrayBuffer();
        const db = await ctx.decodeAudioData(ab);
        setVinhetaBuffer(db);
        setVinhetaName(file.name);
        setIsVideoVinheta(file.type.startsWith('video') || file.name.match(/\.(mp4|mov)$/i));
    } catch(e) { alert("Erro no arquivo de vinheta."); }
  };

  const handleMusicUpload = (e) => {
    const files = Array.from(e.target.files);
    addFiles(files);
  };

  const handleZipUpload = async (e) => {
    if (!jsZipLoaded) return;
    setIsZipping(true);
    try {
        const zip = new window.JSZip();
        const content = await zip.loadAsync(e.target.files[0]);
        const extracted = [];
        for (const filename of Object.keys(content.files)) {
            if (!content.files[filename].dir && filename.match(/\.(mp3|wav|m4a|mp4)$/i) && !filename.startsWith('__')) {
                const blob = await content.files[filename].async("blob");
                extracted.push(new File([blob], filename.split('/').pop(), { type: 'audio/mpeg' }));
            }
        }
        addFiles(extracted);
    } catch(e) { alert("Erro ao abrir ZIP."); }
    setIsZipping(false);
  };

  const addFiles = (files) => {
    setTracks(prev => [...prev, ...files.map(f => ({
        id: Math.random().toString(36), file: f, status: 'pending', isVideo: f.name.match(/\.(mp4|mov)$/i)
    }))]);
  };

  const startBatch = async () => {
    if (!vinhetaBuffer || tracks.length === 0) return;
    setIsProcessing(true);
    const newTracks = [...tracks];
    for (let i = 0; i < newTracks.length; i++) {
        if (newTracks[i].status !== 'done') {
            newTracks[i].status = 'processing';
            setTracks([...newTracks]);
            await new Promise(r => setTimeout(r, 20));
            newTracks[i] = await processTrack(newTracks[i]);
            setTracks([...newTracks]);
        }
    }
    setIsProcessing(false);
  };

  const downloadAllZip = async () => {
      if(!jsZipLoaded) return;
      setIsZipping(true);
      const zip = new window.JSZip();
      tracks.filter(t => t.status === 'done').forEach(t => {
          zip.file(`${t.file.name.split('.')[0]}_SUITCDS.wav`, t.blob);
      });
      const content = await zip.generateAsync({type:"blob"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = "SUITCDS_PACK.zip";
      a.click();
      setIsZipping(false);
  };

  const togglePreview = (track) => {
      if(playingId === track.id) { audioPlayerRef.current.pause(); setPlayingId(null); }
      else { audioPlayerRef.current.src = URL.createObjectURL(track.blob); audioPlayerRef.current.play(); setPlayingId(track.id); }
  };

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-100 font-sans selection:bg-indigo-500/30">
      <audio ref={audioPlayerRef} onEnded={() => setPlayingId(null)} />
      
      {/* HEADER MINIMALISTA - SUITCDS */}
      <header className="py-8 px-4 border-b border-zinc-900 bg-black/20 backdrop-blur-sm sticky top-0 z-40">
        <div className="max-w-2xl mx-auto flex items-center justify-between">
            <div>
                <h1 className="text-2xl font-bold tracking-tight text-white flex items-center gap-2">
                    <Layers className="text-indigo-500" />
                    SuitCds
                </h1>
                <p className="text-xs text-zinc-500 font-medium tracking-widest mt-1">SUITE DE AUTOMA√á√ÉO DE √ÅUDIO</p>
            </div>
            <div className="flex gap-2 text-xs font-mono text-zinc-600">
                <span>V3.0</span>
                <span className="text-indigo-500">PRO</span>
            </div>
        </div>
      </header>

      <main className="max-w-2xl mx-auto p-4 space-y-8 pb-32">
        
        {/* SETOR 1: IDENTIDADE (VINHETA) */}
        <section>
            <h2 className="text-xs font-bold text-zinc-500 uppercase mb-3 flex items-center gap-2">
                <Radio size={12}/> Identidade Sonora
            </h2>
            
            <div className="relative group overflow-hidden rounded-2xl bg-zinc-900 border border-zinc-800 hover:border-indigo-500/50 transition-all">
                <input type="file" onChange={handleVinhetaUpload} accept="audio/*,video/*" className="absolute inset-0 z-20 opacity-0 cursor-pointer" />
                <div className="p-6 flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center ${vinhetaBuffer ? 'bg-indigo-500 text-white' : 'bg-zinc-800 text-zinc-600'}`}>
                            {isVideoVinheta ? <FileVideo size={20}/> : <Volume2 size={20}/>}
                        </div>
                        <div>
                            <div className="font-medium text-sm text-zinc-200">
                                {vinhetaName || "Carregar Vinheta Principal"}
                            </div>
                            <div className="text-xs text-zinc-500 mt-0.5">
                                {vinhetaBuffer ? `${vinhetaBuffer.duration.toFixed(1)}s ‚Ä¢ √Åudio Extra√≠do` : "Toque para selecionar MP3 ou MP4"}
                            </div>
                        </div>
                    </div>
                    {vinhetaBuffer && <div className="text-xs font-bold text-indigo-400 bg-indigo-500/10 px-3 py-1 rounded-full">PRONTO</div>}
                </div>
            </div>
        </section>

        {/* SETOR 2: L√ìGICA DE MIXAGEM (CONFIGURA√á√ïES) */}
        <section>
            <h2 className="text-xs font-bold text-zinc-500 uppercase mb-3 flex items-center gap-2">
                <Sliders size={12}/> L√≥gica de Mixagem
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                {/* ONDE INSERIR */}
                <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800">
                    <label className="text-[10px] text-zinc-500 uppercase font-bold mb-2 block">Detec√ß√£o</label>
                    <select value={detectMode} onChange={e=>setDetectMode(e.target.value)} className="w-full bg-black text-xs p-2 rounded border border-zinc-700 outline-none focus:border-indigo-500">
                        <option value="start">In√≠cio (0:00)</option>
                        <option value="smart30">Smart (Primeiros 30s)</option>
                        <option value="smart60">Smart (Primeiro 1min)</option>
                        <option value="calmest">Scanner (M√∫sica Toda)</option>
                    </select>
                </div>

                {/* COMO MIXAR */}
                <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800">
                    <label className="text-[10px] text-zinc-500 uppercase font-bold mb-2 block">Estilo Mix</label>
                    <select value={mixMode} onChange={e=>setMixMode(e.target.value)} className="w-full bg-black text-xs p-2 rounded border border-zinc-700 outline-none focus:border-indigo-500">
                        <option value="ducking">R√°dio (Suave)</option>
                        <option value="cut">Seco (Corte Total)</option>
                        <option value="overlay">Rave (Por Cima)</option>
                    </select>
                </div>

                {/* EFEITOS ESPECIAIS (SFX) */}
                <div className="bg-zinc-900 p-3 rounded-xl border border-zinc-800">
                    <label className="text-[10px] text-zinc-500 uppercase font-bold mb-2 block flex items-center gap-1">
                        Efeitos SFX <Zap size={10} className="text-yellow-500"/>
                    </label>
                    <select value={sfxMode} onChange={e=>setSfxMode(e.target.value)} className="w-full bg-black text-xs p-2 rounded border border-zinc-700 outline-none focus:border-indigo-500">
                        <option value="none">Nenhum</option>
                        <option value="airhorn">üì£ Airhorn (Reggae)</option>
                        <option value="impact">üí• Impacto (Boom)</option>
                    </select>
                </div>
            </div>
        </section>

        {/* SETOR 3: CONTE√öDO (PLAYLIST) */}
        <section>
            <h2 className="text-xs font-bold text-zinc-500 uppercase mb-3 flex items-center gap-2">
                <Disc size={12}/> Playlist
            </h2>

            <div className="flex gap-2 mb-4">
                 <div className="relative flex-1">
                    <input type="file" multiple onChange={handleMusicUpload} accept="audio/*,video/*" className="absolute inset-0 opacity-0 cursor-pointer z-10"/>
                    <button className="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 py-3 rounded-xl text-xs font-bold transition-colors border border-zinc-700">
                        + ARQUIVOS SOLTOS
                    </button>
                 </div>
                 <div className="relative flex-1">
                    <input type="file" onChange={handleZipUpload} accept=".zip" className="absolute inset-0 opacity-0 cursor-pointer z-10"/>
                    <button className="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 py-3 rounded-xl text-xs font-bold transition-colors border border-zinc-700 flex items-center justify-center gap-2">
                        <Archive size={14}/> IMPORTAR ZIP
                    </button>
                 </div>
            </div>

            <div className="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden min-h-[100px]">
                {tracks.length === 0 ? (
                    <div className="p-8 text-center text-zinc-600 text-xs">
                        Arraste arquivos ou selecione acima.<br/>Aceita MP3, WAV, MP4 e ZIP.
                    </div>
                ) : (
                    <div className="divide-y divide-zinc-800 max-h-[400px] overflow-y-auto">
                        {tracks.map(track => (
                            <div key={track.id} className="p-3 flex items-center justify-between hover:bg-zinc-800/50 transition-colors">
                                <div className="flex items-center gap-3 min-w-0">
                                    <div className={`w-8 h-8 rounded flex items-center justify-center ${track.status==='done'?'bg-green-500/10 text-green-500':'bg-zinc-800 text-zinc-500'}`}>
                                        {track.status==='processing'?<Loader2 size={14} className="animate-spin"/>:<Music size={14}/>}
                                    </div>
                                    <div className="min-w-0">
                                        <div className="text-xs font-medium text-zinc-300 truncate w-32 md:w-64">{track.file.name}</div>
                                        <div className="text-[10px] text-zinc-500 uppercase">{track.message || "Aguardando"}</div>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    {track.status === 'done' && (
                                        <button onClick={()=>togglePreview(track)} className={`p-2 rounded hover:bg-zinc-700 ${playingId===track.id ? 'text-indigo-400':'text-zinc-400'}`}>
                                            {playingId===track.id ? <Pause size={14}/> : <Play size={14}/>}
                                        </button>
                                    )}
                                    <button onClick={()=>setTracks(t=>t.filter(x=>x.id!==track.id))} className="p-2 text-zinc-600 hover:text-red-400">
                                        <X size={14}/>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </section>

      </main>

      {/* FOOTER ACTIONS */}
      <footer className="fixed bottom-0 left-0 right-0 bg-zinc-950/80 backdrop-blur-md border-t border-zinc-900 p-4 z-50">
         <div className="max-w-2xl mx-auto flex gap-3">
            <button 
                onClick={startBatch}
                disabled={isProcessing || !vinhetaBuffer || tracks.length === 0}
                className={`flex-1 py-4 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all ${
                    isProcessing ? 'bg-zinc-800 text-zinc-500' : 'bg-white text-black hover:bg-zinc-200'
                }`}
            >
                {isProcessing ? <Loader2 className="animate-spin"/> : <Zap className="fill-current"/>}
                {isProcessing ? 'PROCESSANDO...' : 'INICIAR MIXAGEM'}
            </button>
            
            {tracks.some(t => t.status === 'done') && (
                <button 
                    onClick={downloadAllZip}
                    disabled={isZipping}
                    className="w-1/3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all"
                >
                    {isZipping ? <Loader2 className="animate-spin"/> : <Download/>}
                    ZIP
                </button>
            )}
         </div>
      </footer>
    </div>
  );
}


