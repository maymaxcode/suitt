<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SuitCds V25 Protection</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* BASE */
        body { 
            background-color: #050505; 
            color: #e4e4e7; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, sans-serif;
            overflow-x: hidden;
        }

        /* NEVE SUTIL */
        .snowflake {
            position: fixed; top: -10px; background: rgba(255,255,255,0.5);
            border-radius: 50%; pointer-events: none; z-index: 0; animation: fall linear infinite;
        }
        @keyframes fall { to { transform: translateY(110vh); } }

        /* PHANTOM INPUT */
        .phantom-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; z-index: 20; cursor: pointer;
        }

        /* CARD */
        .glass { 
            background: rgba(18, 18, 21, 0.9); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08);
        }
        .card {
            @apply glass; border-radius: 16px; position: relative; z-index: 10; transition: transform 0.1s;
        }
        .card:active { transform: scale(0.99); background: rgba(30, 30, 35, 0.95); }
        
        /* SLOT */
        .slot-filled { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.1); }
        
        /* PLAYER SLIDER */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #fff; cursor: pointer; margin-top: -5px; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; cursor: pointer; background: #3f3f46; border-radius: 2px;
        }
        
        /* UTILS */
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* TOAST */
        .toast {
            position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #fff; color: #000; padding: 10px 20px; border-radius: 50px;
            font-weight: 700; font-size: 12px; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 100;
            display: flex; align-items: center; gap: 8px; width: max-content;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen pb-44">

    <audio id="preview-audio" playsinline webkit-playsinline></audio>

    <div id="toast"><i data-lucide="check" class="w-4 h-4"></i> <span id="toast-msg">Notifica√ß√£o</span></div>

    <!-- HEADER -->
    <header class="pt-8 pb-6 px-6 border-b border-white/5 bg-black/60 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-tr from-violet-600 to-purple-600 text-white rounded-lg flex items-center justify-center shadow-lg shadow-violet-500/20">
                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                </div>
                <h1 class="text-lg font-semibold tracking-tight">SuitCds <span class="text-violet-500 font-normal">V25</span></h1>
            </div>
            <div class="text-[10px] font-mono text-zinc-500 uppercase tracking-widest border border-zinc-800 px-2 py-1 rounded-full bg-black/50">
                1-MIN SAFE
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-4 space-y-8 relative z-10">

        <!-- 1. VINHETAS -->
        <section>
            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider">1. Vinhetas</h2>
                <span id="slot-counter" class="text-[10px] text-zinc-600 font-mono">0/4</span>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <!-- SLOT 1 -->
                <div class="card h-24 flex flex-col items-center justify-center gap-2" id="slot-1">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(0, this)">
                    <div id="icon-1" class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 transition-colors">1</div>
                    <span id="name-1" class="text-[11px] font-medium text-zinc-400 truncate w-full px-3 text-center">Toque Aqui</span>
                    <button onclick="clearVinheta(0, event)" id="btn-clr-1" class="hidden absolute top-1 right-1 p-2 text-zinc-500 hover:text-white z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <!-- SLOT 2 -->
                <div class="card h-24 flex flex-col items-center justify-center gap-2" id="slot-2">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(1, this)">
                    <div id="icon-2" class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 transition-colors">2</div>
                    <span id="name-2" class="text-[11px] font-medium text-zinc-400 truncate w-full px-3 text-center">Toque Aqui</span>
                    <button onclick="clearVinheta(1, event)" id="btn-clr-2" class="hidden absolute top-1 right-1 p-2 text-zinc-500 hover:text-white z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <!-- SLOT 3 -->
                <div class="card h-24 flex flex-col items-center justify-center gap-2" id="slot-3">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(2, this)">
                    <div id="icon-3" class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 transition-colors">3</div>
                    <span id="name-3" class="text-[11px] font-medium text-zinc-400 truncate w-full px-3 text-center">Toque Aqui</span>
                    <button onclick="clearVinheta(2, event)" id="btn-clr-3" class="hidden absolute top-1 right-1 p-2 text-zinc-500 hover:text-white z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <!-- SLOT 4 -->
                <div class="card h-24 flex flex-col items-center justify-center gap-2" id="slot-4">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(3, this)">
                    <div id="icon-4" class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 transition-colors">4</div>
                    <span id="name-4" class="text-[11px] font-medium text-zinc-400 truncate w-full px-3 text-center">Toque Aqui</span>
                    <button onclick="clearVinheta(3, event)" id="btn-clr-4" class="hidden absolute top-1 right-1 p-2 text-zinc-500 hover:text-white z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            </div>
        </section>

        <!-- 2. SETUP -->
        <section>
            <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 px-1">2. L√≥gica (Prote√ß√£o Ativa)</h2>
            
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div class="card p-2">
                        <label class="text-[9px] text-zinc-500 font-bold px-2 uppercase">Modo</label>
                        <select id="sel-pos" class="w-full bg-transparent text-xs text-white p-2 outline-none">
                            <option value="smartSafe" selected>üõ°Ô∏è Safe (1 min antes fim)</option>
                            <option value="smart30">üß† Smart (30s iniciais)</option>
                            <option value="start">‚ñ∂Ô∏è In√≠cio (0:00)</option>
                            <option value="intro">‚è≥ Intro (15s)</option>
                            <option value="multi" disabled>‚ú® Multi (Auto)</option>
                        </select>
                    </div>
                    <div class="card p-2">
                        <label class="text-[9px] text-zinc-500 font-bold px-2 uppercase">Estilo</label>
                        <select id="sel-mix" class="w-full bg-transparent text-xs text-white p-2 outline-none">
                            <option value="ducking">üìª R√°dio (Suave)</option>
                            <option value="cut">‚úÇÔ∏è Seco (Corte)</option>
                            <option value="overlay">üî• Rave (Por Cima)</option>
                        </select>
                    </div>
                </div>

                <!-- SFX -->
                <div class="card p-3 flex items-center gap-3">
                    <div class="w-8 h-8 bg-violet-500/20 rounded-lg flex items-center justify-center text-violet-400 shrink-0">
                        <i data-lucide="zap" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1">
                        <label class="text-[9px] text-zinc-500 font-bold uppercase block">Efeito Sonoro</label>
                        <select id="sel-sfx" class="w-full bg-transparent text-sm text-white outline-none">
                            <option value="none">Nenhum</option>
                            <option value="airhorn">üì£ Airhorn</option>
                            <option value="laser">üî´ Laser</option>
                            <option value="impact">üí• Impacto</option>
                            <option value="riser">üöÄ Riser</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. M√öSICAS -->
        <section>
            <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 px-1">3. M√∫sicas</h2>

            <div class="flex gap-3 mb-4">
                <div class="card flex-1 h-14 flex flex-row items-center justify-center gap-2 active:bg-zinc-900">
                    <input type="file" class="phantom-input" id="inp-music" multiple accept="*">
                    <i data-lucide="music" class="w-4 h-4 text-violet-400"></i>
                    <span class="text-[10px] font-bold text-zinc-300">ARQUIVOS</span>
                </div>
                <div class="card flex-1 h-14 flex flex-row items-center justify-center gap-2 active:bg-zinc-900">
                    <input type="file" class="phantom-input" id="inp-zip" accept="*">
                    <i data-lucide="archive" class="w-4 h-4 text-purple-400"></i>
                    <span class="text-[10px] font-bold text-zinc-300">ABRIR ZIP</span>
                </div>
            </div>

            <!-- LISTA (Com Player Embutido) -->
            <div id="list-container" class="hidden space-y-3 pb-4">
                <!-- Items Injected Here -->
            </div>
            
            <div id="empty-msg" class="text-center py-10 text-zinc-700">
                <i data-lucide="disc" class="w-8 h-8 mx-auto mb-2 opacity-20"></i>
                <p class="text-xs">Lista vazia</p>
            </div>
        </section>

    </main>

    <!-- FOOTER -->
    <footer class="fixed bottom-0 left-0 right-0 bg-black/90 backdrop-blur-xl border-t border-white/5 p-5 z-50 pb-8">
        <div class="max-w-xl mx-auto flex gap-3">
            <button id="btn-process" onclick="startMix()" disabled class="flex-1 bg-zinc-900 text-zinc-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-50">
                <span>AGUARDANDO...</span>
            </button>
            <button id="btn-download" onclick="downloadZip()" class="hidden w-[40%] bg-white text-black h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-[0_0_20px_rgba(255,255,255,0.2)]">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span>ZIP</span>
            </button>
        </div>
    </footer>

    <script>
        // --- SNOW EFFECT ---
        function createSnow() {
            const container = document.body;
            for(let i=0; i<30; i++) {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                const size = Math.random() * 2 + 1 + 'px';
                flake.style.width = size;
                flake.style.height = size;
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.opacity = Math.random() * 0.4 + 0.1;
                flake.style.animationDuration = Math.random() * 5 + 8 + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(flake);
            }
        }
        createSnow();

        // --- CORE VARIABLES ---
        let audioCtx;
        let vinhetaSlots = [null, null, null, null];
        let tracks = [];
        let isProcessing = false;
        let playingId = null;
        let savedMode = 'smartSafe';

        lucide.createIcons();

        // Unlock Audio
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        ['click','touchstart','change'].forEach(e => document.addEventListener(e, initAudio, {passive:true}));

        function notify(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        document.getElementById('sel-pos').addEventListener('change', function(){
            if(this.value !== 'multi') savedMode = this.value;
        });

        function formatTime(sec) {
            if(!sec || isNaN(sec)) return "0:00";
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        // --- LOADERS ---
        async function loadVinheta(idx, input) {
            const file = input.files[0];
            if(!file) return;
            
            const nameEl = document.getElementById(`name-${idx+1}`);
            const iconEl = document.getElementById(`icon-${idx+1}`);
            nameEl.innerText = "Lendo...";
            
            try {
                const ab = await file.arrayBuffer();
                const buf = await audioCtx.decodeAudioData(ab);
                
                vinhetaSlots[idx] = { buffer: buf, duration: buf.duration, name: file.name };
                
                document.getElementById(`slot-${idx+1}`).classList.add('slot-filled');
                iconEl.className = "w-8 h-8 rounded-full bg-violet-600 text-white flex items-center justify-center";
                iconEl.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                nameEl.innerText = file.name;
                nameEl.classList.add('text-white');
                document.getElementById(`btn-clr-${idx+1}`).classList.remove('hidden');
                
                lucide.createIcons();
                notify("Vinheta carregada");
                updateState();
            } catch(e) {
                notify("Erro no arquivo");
                nameEl.innerText = "Erro";
            }
            input.value = ''; 
        }

        function clearVinheta(idx, e) {
            e.preventDefault(); e.stopPropagation();
            vinhetaSlots[idx] = null;
            document.getElementById(`slot-${idx+1}`).classList.remove('slot-filled');
            const iconEl = document.getElementById(`icon-${idx+1}`);
            const nameEl = document.getElementById(`name-${idx+1}`);
            iconEl.className = "w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 transition-colors";
            iconEl.innerHTML = idx+1;
            nameEl.innerText = "Toque Aqui";
            nameEl.classList.remove('text-white');
            document.getElementById(`btn-clr-${idx+1}`).classList.add('hidden');
            updateState();
        }

        document.getElementById('inp-music').onchange = function() {
            if(this.files.length) {
                Array.from(this.files).forEach(f => {
                    tracks.push({ id: Math.random().toString(36).slice(2), file: f, status: 'pending', msg: 'Aguardando', blob: null, spot: 0 });
                });
                notify(`${this.files.length} m√∫sicas`);
                updateState();
            }
            this.value = '';
        };

        document.getElementById('inp-zip').onchange = async function() {
            const f = this.files[0];
            if(!f) return;
            notify("Lendo ZIP...");
            try {
                const z = new JSZip();
                const c = await z.loadAsync(f);
                let count = 0;
                for(let k of Object.keys(c.files)) {
                    if(!c.files[k].dir && !k.startsWith('__')) {
                        const b = await c.files[k].async("blob");
                        tracks.push({ id: Math.random().toString(36).slice(2), file: new File([b], k.split('/').pop()), status: 'pending', msg: 'Do ZIP', blob: null, spot: 0 });
                        count++;
                    }
                }
                notify(`${count} extra√≠dos`);
                updateState();
            } catch(e) { notify("Erro no ZIP"); }
            this.value = '';
        };

        // --- UI ---
        function updateState() {
            const list = document.getElementById('list-container');
            const empty = document.getElementById('empty-msg');
            const btn = document.getElementById('btn-process');
            
            const activeV = vinhetaSlots.filter(v=>v).length;
            const selPos = document.getElementById('sel-pos');
            
            if(activeV > 1) {
                selPos.innerHTML = '<option value="multi">‚ú® Multi-Vinheta (Auto)</option>';
                selPos.disabled = true;
            } else if(selPos.disabled) {
                selPos.disabled = false;
                selPos.innerHTML = `<option value="smartSafe">üõ°Ô∏è Safe (1 min antes fim)</option><option value="smart30">üß† Smart (30s)</option><option value="start">‚ñ∂Ô∏è In√≠cio (0:00)</option>`;
                selPos.value = savedMode;
            }
            document.getElementById('slot-counter').innerText = `${activeV}/4`;

            if(tracks.length > 0) {
                empty.classList.add('hidden'); list.classList.remove('hidden');
                list.innerHTML = tracks.map(t => {
                    const isPlaying = playingId === t.id;
                    let controls = '';

                    if(t.status === 'done') {
                        controls = `
                        <div class="flex flex-col gap-2 w-full mt-2 pt-2 border-t border-white/5">
                            <div class="flex items-center gap-2">
                                <button onclick="togglePlay('${t.id}')" class="w-8 h-8 rounded-full ${isPlaying ? 'bg-violet-600 text-white' : 'bg-zinc-800 text-violet-400'} flex items-center justify-center shrink-0">
                                    <i data-lucide="${isPlaying ? 'pause' : 'play'}" class="w-4 h-4 fill-current"></i>
                                </button>
                                <input type="range" min="0" max="${t.duration || 100}" value="${t.currentTime || 0}" oninput="seekTrack('${t.id}', this.value)" class="flex-1">
                                <span class="text-[9px] font-mono text-zinc-500 w-8 text-right">${formatTime(t.currentTime || 0)}</span>
                            </div>
                            <button onclick="jumpToMix('${t.id}')" class="flex items-center justify-center gap-1 w-full bg-zinc-800/50 hover:bg-zinc-800 text-[10px] py-1.5 rounded text-zinc-300 transition-colors">
                                <i data-lucide="crosshair" class="w-3 h-3 text-violet-500"></i> Ouvir Mix (${formatTime(t.spot)})
                            </button>
                        </div>`;
                    } else if(t.status === 'processing') {
                        controls = `<div class="mt-2 text-[10px] text-zinc-500 flex items-center gap-2"><i data-lucide="loader-2" class="w-3 h-3 spin"></i> Processando...</div>`;
                    }

                    return `
                    <div class="card p-3 group">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <i data-lucide="music" class="w-4 h-4 shrink-0 ${t.status==='done'?'text-violet-500':'text-zinc-600'}"></i>
                                <div class="truncate">
                                    <div class="text-xs text-white truncate font-medium">${t.file.name}</div>
                                    <div class="text-[10px] text-zinc-500">${t.msg}</div>
                                </div>
                            </div>
                            <button onclick="remTrack('${t.id}')" class="p-1 text-zinc-600 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        ${controls}
                    </div>`;
                }).join('');
                lucide.createIcons();
            } else {
                empty.classList.remove('hidden'); list.classList.add('hidden');
            }

            const ready = activeV > 0 && tracks.length > 0;
            const done = tracks.some(t => t.status === 'done');
            
            if(isProcessing) {
                btn.disabled = true; btn.className = "flex-1 bg-zinc-800 text-zinc-500 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> MIXANDO...`;
            } else if(ready) {
                btn.disabled = false; btn.className = "flex-1 bg-white text-black h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(255,255,255,0.2)] active:scale-95 transition-transform";
                btn.innerText = done ? "REFAZER" : "INICIAR";
            } else {
                btn.disabled = true; btn.className = "flex-1 bg-zinc-900 text-zinc-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerText = activeV === 0 ? "CARREGUE VINHETA" : "ADD M√öSICAS";
            }
            
            document.getElementById('btn-download').classList.toggle('hidden', !done || isProcessing);
            lucide.createIcons();
        }

        window.remTrack = (id) => { 
            if(playingId === id) { document.getElementById('preview-audio').pause(); playingId = null; }
            tracks = tracks.filter(t => t.id !== id); updateState(); 
        }

        // --- PLAYER ---
        const audioEl = document.getElementById('preview-audio');
        window.togglePlay = (id) => {
            const t = tracks.find(x => x.id === id);
            if(playingId === id) { audioEl.pause(); playingId = null; } 
            else { if(t.blob) { audioEl.src = URL.createObjectURL(t.blob); audioEl.play(); playingId = id; } }
            updateState();
        }
        window.seekTrack = (id, val) => { if(playingId === id) audioEl.currentTime = val; }
        window.jumpToMix = (id) => {
            const t = tracks.find(x => x.id === id);
            if(t && t.spot) {
                if(playingId !== id) { audioEl.src = URL.createObjectURL(t.blob); playingId = id; }
                audioEl.currentTime = Math.max(0, t.spot - 2); audioEl.play(); updateState(); notify(`Pulou para ${formatTime(audioEl.currentTime)}`);
            }
        }
        setInterval(() => { if(playingId) updateState(); }, 1000);
        audioEl.ontimeupdate = () => { if(playingId) { const t = tracks.find(x => x.id === playingId); t.currentTime = audioEl.currentTime; } };
        audioEl.onended = () => { playingId = null; updateState(); };
        audioEl.onloadedmetadata = () => { if(playingId) { const t = tracks.find(x => x.id === playingId); t.duration = audioEl.duration; } }

        // --- AUDIO ENGINE (1-MIN SAFE) ---
        function findSafeSpot(raw, sr, count, limit, vinhetaLen) {
            const windowNeed = (vinhetaLen + 2) * sr; 
            const limitSamples = limit > 0 ? (limit * sr) : raw.length;
            
            // PROTE√á√ÉO: EVITA √öLTIMOS 60 SEGUNDOS (1 MINUTO)
            const avoidEndSamples = 60 * sr;
            
            // O limite real √© o menor entre (limite do usu√°rio) e (fim da musica - 60s)
            const actLim = Math.min(limitSamples, raw.length - avoidEndSamples);

            // Se a m√∫sica for muito curta (< 1min), fallback para in√≠cio
            if (actLim <= windowNeed) return [0];

            const step = Math.floor(sr * 1); // 1s steps
            let bestSpot = 5 * sr; // Pula intro 5s
            let bestEnergy = Infinity;

            for(let i = 5*sr; i < actLim - windowNeed; i += step) {
                let sum = 0;
                for(let k = 0; k < windowNeed; k+=500) {
                    const idx = Math.floor(i + k);
                    if(idx < raw.length) sum += Math.abs(raw[idx]);
                }
                const energy = sum / (windowNeed/500);
                if(energy < bestEnergy) {
                    bestEnergy = energy;
                    bestSpot = i;
                }
            }
            return [bestSpot / sr];
        }

        async function getSFX(type, sr) {
            if (!audioCtx || type === 'none') return null;
            const b = audioCtx.createBuffer(2, sr * 2, sr);
            for(let c=0; c<2; c++) {
                const d = b.getChannelData(c);
                for(let i=0; i<d.length; i++) {
                    const t = i/sr;
                    if(type==='airhorn') d[i] = (Math.sin(t*400*6.28)>0?0.5:-0.5)*Math.max(0,1-t/1.5)*0.4;
                    else if(type==='laser') d[i] = Math.sin(t*(800*Math.exp(-t*15))*6.28)*0.5;
                    else if(type==='impact') d[i] = (Math.random()*0.2 + Math.sin(t*50*6.28)*0.8)*Math.exp(-t*4);
                }
            }
            return b;
        }

        async function startMix() {
            if(isProcessing) return;
            isProcessing = true; updateState(); initAudio();

            const activeV = vinhetaSlots.filter(v=>v);
            const mode = document.getElementById('sel-pos').value;
            const mix = document.getElementById('sel-mix').value;
            const sfxT = document.getElementById('sel-sfx').value;

            for(let i=0; i<tracks.length; i++) {
                if(tracks[i].status !== 'done') {
                    tracks[i].status = 'processing'; tracks[i].msg = 'Processando...'; updateState();
                    await new Promise(r=>setTimeout(r,20));

                    try {
                        const ab = await tracks[i].file.arrayBuffer();
                        const mb = await audioCtx.decodeAudioData(ab);
                        
                        let spots = [0];
                        if(mode === 'intro') spots = [15];
                        else if(mode === 'start') spots = [0];
                        else {
                            let lim = mode==='smart30'?30 : 0;
                            // Uses FIRST Vinheta length for calculation
                            spots = findSafeSpot(mb.getChannelData(0), mb.sampleRate, 1, lim, activeV[0].duration);
                        }

                        const sBuf = await getSFX(sfxT, mb.sampleRate);
                        const sDur = sBuf ? 1.5 : 0;

                        const off = new OfflineAudioContext(2, mb.length, mb.sampleRate);
                        const ms = off.createBufferSource(); ms.buffer = mb;
                        const mg = off.createGain();
                        
                        mg.gain.setValueAtTime(1,0);
                        spots.forEach((st, idx) => {
                            if(idx >= activeV.length) return;
                            const dur = activeV[idx].duration + sDur;
                            if(mix==='ducking') {
                                mg.gain.setValueAtTime(1, st);
                                mg.gain.linearRampToValueAtTime(0.3, st+0.3);
                                mg.gain.setValueAtTime(0.3, st+dur-0.3);
                                mg.gain.linearRampToValueAtTime(1, st+dur);
                            } else if(mix==='cut') {
                                mg.gain.setValueAtTime(1, st);
                                mg.gain.linearRampToValueAtTime(0, st+0.05);
                                mg.gain.setValueAtTime(0, st+dur-0.05);
                                mg.gain.linearRampToValueAtTime(1, st+dur);
                            }
                        });
                        ms.connect(mg); mg.connect(off.destination); ms.start(0);

                        spots.forEach((st, idx) => {
                            if(idx >= activeV.length) return;
                            if(sBuf) {
                                const ss = off.createBufferSource(); ss.buffer = sBuf;
                                const sg = off.createGain(); sg.gain.value = 0.7;
                                ss.connect(sg); sg.connect(off.destination); ss.start(st);
                            }
                            const vs = off.createBufferSource(); vs.buffer = activeV[idx].buffer;
                            const vg = off.createGain(); vg.gain.value = mix==='overlay'?1.3:1.1;
                            vs.connect(vg); vg.connect(off.destination); 
                            vs.start(st + (sBuf?0.5:0));
                        });

                        const ren = await off.startRendering();
                        tracks[i].blob = bufferToWave(ren);
                        tracks[i].status = 'done';
                        tracks[i].spot = spots[0];
                        tracks[i].msg = 'Sucesso';
                        tracks[i].duration = mb.duration;
                    } catch(e) {
                        tracks[i].status = 'error'; tracks[i].msg = 'Erro';
                    }
                }
            }
            isProcessing = false; updateState(); notify("Mixagem conclu√≠da!");
        }

        function bufferToWave(abuffer) {
            let numOfChan = abuffer.numberOfChannels, length = abuffer.length * numOfChan * 2 + 44, buffer = new ArrayBuffer(length), view = new DataView(buffer), channels = [], i, sample, offset = 0, pos = 0;
            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157); setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan); setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan); setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - pos - 4);
            for(i=0; i<numOfChan; i++) channels.push(abuffer.getChannelData(i));
            while(pos < abuffer.length) {
                for(i=0; i<numOfChan; i++) { sample = Math.max(-1, Math.min(1, channels[i][pos])); sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0; view.setInt16(44 + offset, sample, true); offset += 2; } pos++;
            }
            return new Blob([buffer], { type: "audio/wav" });
        }

        window.downloadZip = async () => { 
            const z = new JSZip(); let c = 0; notify("Gerando ZIP...");
            tracks.forEach((t, idx) => { 
                if (t.status === 'done' && t.blob) { 
                    z.file(`${idx+1}_${t.file.name.replace(/[^a-z0-9]/gi, '_')}.wav`, t.blob); 
                    c++; 
                } 
            }); 
            if(c>0) {
                try {
                    const b = await z.generateAsync({type:"blob", compression:"STORE"}); 
                    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = "SuitCds_Pack.zip"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                } catch(e) { notify("Erro mem√≥ria"); }
            } else notify("Nada para baixar");
        };
    </script>
</body>
</html>


