<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SuitCds V28 Universal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* BASE & THEME */
        body { 
            background-color: #050505; 
            color: #e4e4e7; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, sans-serif;
            overflow-x: hidden;
        }

        /* ANIMA√á√ÉO DE FUNDO (NEVE) */
        .snowflake {
            position: fixed; top: -10px; background: rgba(255,255,255,0.2);
            border-radius: 50%; pointer-events: none; z-index: 0; animation: fall linear infinite;
        }
        @keyframes fall { to { transform: translateY(110vh); } }

        /* INPUT INVIS√çVEL PARA CLIQUE EM CARD INTEIRO */
        .phantom-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; z-index: 20; cursor: pointer;
        }

        /* EFEITO DE VIDRO (GLASSMORPHISM) */
        .glass { 
            background: rgba(20, 20, 25, 0.85); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card {
            @apply glass; border-radius: 16px; position: relative; z-index: 10; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:active { transform: scale(0.98); background: rgba(40, 40, 45, 0.9); }
        
        .slot-filled { border-color: #22c55e; background: rgba(34, 197, 94, 0.05); }
        
        /* PLAYER CUSTOMIZADO */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #fff; cursor: pointer; margin-top: -5px; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; cursor: pointer; background: #3f3f46; border-radius: 2px;
        }
        
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* TOAST NOTIFICATION */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #fff; color: #000; padding: 12px 24px; border-radius: 50px;
            font-weight: 700; font-size: 13px; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 100;
            display: flex; align-items: center; gap: 8px; width: max-content;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen pb-44 selection:bg-green-500/30">

    <audio id="preview-audio" playsinline webkit-playsinline></audio>

    <!-- TOAST -->
    <div id="toast"><i data-lucide="info" class="w-4 h-4"></i> <span id="toast-msg">Info</span></div>

    <!-- HEADER -->
    <header class="pt-8 pb-6 px-6 border-b border-white/5 bg-black/60 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-emerald-800 text-white rounded-xl flex items-center justify-center shadow-lg shadow-green-900/40">
                    <i data-lucide="folder-open" class="w-5 h-5 fill-current"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white leading-tight">SuitCds</h1>
                    <p class="text-[10px] text-zinc-500 font-bold tracking-[0.2em] uppercase">V28 UNIVERSAL</p>
                </div>
            </div>
            <div class="px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800 text-[10px] font-mono text-zinc-500">
                PRO
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-5 space-y-8 relative z-10">

        <!-- 1. VINHETAS -->
        <section>
            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-4 h-4 rounded bg-zinc-800 text-white flex items-center justify-center text-[10px]">1</span> 
                    Carregar Vinhetas
                </h2>
                <span id="slot-counter" class="text-[10px] text-zinc-600 font-mono bg-zinc-900 px-2 py-0.5 rounded">0/2</span>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <!-- SLOT 1 -->
                <div class="card h-24 flex flex-col items-center justify-center gap-2 group" id="slot-1">
                    <!-- CHANGE: accept="*" to allow all files -->
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(0, this)">
                    <div id="icon-1" class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 group-hover:border-green-500/50 transition-colors">1</div>
                    <span id="name-1" class="text-[11px] font-medium text-zinc-400 truncate w-full px-3 text-center">Toque para adicionar</span>
                    <button onclick="clearVinheta(0, event)" id="btn-clr-1" class="hidden absolute top-1 right-1 p-2 text-zinc-500 hover:text-red-400 z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <!-- SLOT 2 -->
                <div class="card h-24 flex flex-col items-center justify-center gap-2 group" id="slot-2">
                    <input type="file" class="phantom-input" accept="*" onchange="loadVinheta(1, this)">
                    <div id="icon-2" class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 group-hover:border-green-500/50 transition-colors">2</div>
                    <span id="name-2" class="text-[11px] font-medium text-zinc-400 truncate w-full px-3 text-center">Toque para adicionar</span>
                    <button onclick="clearVinheta(1, event)" id="btn-clr-2" class="hidden absolute top-1 right-1 p-2 text-zinc-500 hover:text-red-400 z-30"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            </div>
        </section>

        <!-- 2. SETUP -->
        <section>
            <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider mb-4 px-1 flex items-center gap-2">
                <span class="w-4 h-4 rounded bg-zinc-800 text-white flex items-center justify-center text-[10px]">2</span> 
                Configura√ß√£o DJ
            </h2>
            
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div class="card p-3 relative overflow-hidden">
                        <label class="text-[9px] text-zinc-500 font-bold uppercase block mb-1">Posi√ß√£o</label>
                        <select id="sel-pos" class="w-full bg-transparent text-xs text-white outline-none cursor-pointer appearance-none relative z-10 font-medium">
                            <option value="safeEnd">üõ°Ô∏è Final Safe (Fim -15s)</option>
                            <option value="start">‚ñ∂Ô∏è In√≠cio (0:00)</option>
                            <option value="intro">‚è≥ Intro (0:15)</option>
                            <option value="middle">üìè Meio (50%)</option>
                        </select>
                        <i data-lucide="chevron-down" class="w-3 h-3 text-zinc-600 absolute right-3 bottom-3 z-0"></i>
                    </div>
                    <div class="card p-3 relative overflow-hidden">
                        <label class="text-[9px] text-zinc-500 font-bold uppercase block mb-1">Mixagem</label>
                        <select id="sel-mix" class="w-full bg-transparent text-xs text-white outline-none cursor-pointer appearance-none relative z-10 font-medium">
                            <option value="ducking">üìª R√°dio (Ducking)</option>
                            <option value="overlay">üî• Colagem (Overlay)</option>
                            <option value="cut">‚úÇÔ∏è Seco (Cut)</option>
                        </select>
                        <i data-lucide="chevron-down" class="w-3 h-3 text-zinc-600 absolute right-3 bottom-3 z-0"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. M√öSICAS -->
        <section>
            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-xs font-bold text-zinc-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="w-4 h-4 rounded bg-zinc-800 text-white flex items-center justify-center text-[10px]">3</span> 
                    Playlist
                </h2>
                <span id="track-counter" class="text-[10px] text-zinc-600 font-mono bg-zinc-900 px-2 py-0.5 rounded">0/50</span>
            </div>

            <div class="flex gap-3 mb-4">
                <div class="card flex-1 h-14 flex flex-row items-center justify-center gap-2 active:bg-zinc-800 cursor-pointer relative overflow-hidden hover:border-zinc-600 transition-colors">
                    <!-- CHANGE: accept="*" -->
                    <input type="file" class="phantom-input" id="inp-music" multiple accept="*">
                    <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center">
                        <i data-lucide="music" class="w-4 h-4 text-green-400"></i>
                    </div>
                    <span class="text-[10px] font-bold text-zinc-300">ARQUIVOS</span>
                </div>
                <div class="card flex-1 h-14 flex flex-row items-center justify-center gap-2 active:bg-zinc-800 cursor-pointer relative overflow-hidden hover:border-zinc-600 transition-colors">
                    <!-- CHANGE: accept="*" -->
                    <input type="file" class="phantom-input" id="inp-zip" accept="*">
                    <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center">
                        <i data-lucide="archive" class="w-4 h-4 text-emerald-400"></i>
                    </div>
                    <span class="text-[10px] font-bold text-zinc-300">ABRIR ZIP</span>
                </div>
            </div>

            <!-- LISTA -->
            <div id="list-container" class="hidden space-y-2 pb-4">
                <!-- Items Injected Here -->
            </div>
            
            <div id="empty-msg" class="text-center py-12 border border-dashed border-zinc-800 rounded-2xl">
                <div class="w-12 h-12 rounded-full bg-zinc-900 mx-auto flex items-center justify-center mb-3">
                    <i data-lucide="folder-search" class="w-5 h-5 text-zinc-600"></i>
                </div>
                <p class="text-xs text-zinc-500 font-medium">Lista vazia (Max 50)</p>
                <p class="text-[10px] text-zinc-600 mt-1">Aceita todos os arquivos</p>
            </div>
        </section>

    </main>

    <!-- FOOTER -->
    <footer class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-xl border-t border-white/5 p-5 z-50 pb-8">
        <div class="max-w-xl mx-auto flex gap-3">
            <button id="btn-process" onclick="startProcessing()" disabled class="flex-1 bg-zinc-900 text-zinc-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <span>AGUARDANDO...</span>
            </button>
            <button id="btn-download" onclick="downloadZip()" class="hidden w-[40%] bg-white text-black h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-[0_0_20px_rgba(255,255,255,0.15)] hover:bg-zinc-200">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span>BAIXAR ZIP</span>
            </button>
        </div>
    </footer>

    <script>
        // --- EFEITO DE NEVE ---
        function createSnow() {
            const container = document.body;
            for(let i=0; i<20; i++) {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                const size = Math.random() * 2 + 1 + 'px';
                flake.style.width = size;
                flake.style.height = size;
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.opacity = Math.random() * 0.3 + 0.1;
                flake.style.animationDuration = Math.random() * 10 + 10 + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(flake);
            }
        }
        createSnow();

        // --- VARI√ÅVEIS GLOBAIS ---
        let audioCtx;
        let vinhetaSlots = [null, null]; // Apenas 2 slots para simplificar a UI mobile
        let tracks = [];
        let isProcessing = false;
        let playingId = null;
        const MAX_TRACKS = 50;

        lucide.createIcons();

        // Inicializa AudioContext
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        // Ativar audio context em qualquer clique
        document.body.addEventListener('click', () => initAudio(), {once:true});

        function notify(msg, type='info') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.color = type === 'error' ? '#ef4444' : '#000';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- CARREGAMENTO DE VINHETAS ---
        async function loadVinheta(idx, input) {
            const file = input.files[0];
            if(!file) return;
            initAudio();
            
            const nameEl = document.getElementById(`name-${idx+1}`);
            const iconEl = document.getElementById(`icon-${idx+1}`);
            nameEl.innerText = "Lendo...";
            
            try {
                // Tenta decodificar qualquer coisa
                const ab = await file.arrayBuffer();
                const buf = await audioCtx.decodeAudioData(ab);
                
                vinhetaSlots[idx] = { buffer: buf, duration: buf.duration, name: file.name };
                
                document.getElementById(`slot-${idx+1}`).classList.add('slot-filled');
                iconEl.className = "w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center shadow-lg shadow-green-500/30";
                iconEl.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                nameEl.innerText = file.name;
                nameEl.classList.add('text-white');
                document.getElementById(`btn-clr-${idx+1}`).classList.remove('hidden');
                
                lucide.createIcons();
                updateState();
            } catch(e) {
                notify("Arquivo inv√°lido (n√£o √© √°udio)", "error");
                nameEl.innerText = "Erro - Tente outro";
                console.error(e);
            }
            input.value = ''; 
        }

        function clearVinheta(idx, e) {
            e.preventDefault(); e.stopPropagation();
            vinhetaSlots[idx] = null;
            document.getElementById(`slot-${idx+1}`).classList.remove('slot-filled');
            const iconEl = document.getElementById(`icon-${idx+1}`);
            const nameEl = document.getElementById(`name-${idx+1}`);
            iconEl.className = "w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center text-zinc-500 transition-colors";
            iconEl.innerHTML = idx+1;
            nameEl.innerText = "Toque para adicionar";
            nameEl.classList.remove('text-white');
            document.getElementById(`btn-clr-${idx+1}`).classList.add('hidden');
            updateState();
        }

        // --- CARREGAMENTO DE M√öSICAS ---
        function checkLimit(addCount) {
            if(tracks.length + addCount > MAX_TRACKS) {
                notify(`Limite de ${MAX_TRACKS} arquivos!`, "error");
                return false;
            }
            return true;
        }

        document.getElementById('inp-music').onchange = function() {
            if(this.files.length) {
                if(!checkLimit(this.files.length)) return;
                
                let addedCount = 0;
                Array.from(this.files).forEach(f => {
                    // Aceita tudo, filtra na hora de processar
                    tracks.push({ 
                        id: Math.random().toString(36).slice(2), 
                        file: f, 
                        status: 'pending', 
                        msg: 'Aguardando', 
                        blob: null,
                        originalName: f.name 
                    });
                    addedCount++;
                });
                notify(`${addedCount} arquivos adicionados`);
                updateState();
            }
            this.value = '';
        };

        // --- L√ìGICA DE UNZIP ---
        document.getElementById('inp-zip').onchange = async function() {
            const f = this.files[0];
            if(!f) return;
            notify("Abrindo arquivo...");
            
            try {
                const z = new JSZip();
                // Tenta carregar qualquer arquivo como ZIP
                const c = await z.loadAsync(f);
                let count = 0;
                let pending = [];
                
                // Extens√µes para tentar salvar do ZIP
                const validExt = ['.mp3', '.wav', '.m4a', '.mp4', '.aac', '.flac', '.ogg', '.wma'];

                for(let k of Object.keys(c.files)) {
                    const entry = c.files[k];
                    const nameLower = entry.name.toLowerCase();
                    
                    if(!entry.dir && !nameLower.includes('__macosx') && !nameLower.split('/').pop().startsWith('.')) {
                        // Verifica se parece audio
                        if(validExt.some(ext => nameLower.endsWith(ext))) {
                            pending.push(entry);
                        }
                    }
                }

                if(pending.length === 0) {
                    notify("ZIP sem √°udio v√°lido", "error");
                    return;
                }

                if(!checkLimit(pending.length)) return;

                for(let entry of pending) {
                    const b = await entry.async("blob");
                    const cleanName = entry.name.split('/').pop(); 
                    tracks.push({ 
                        id: Math.random().toString(36).slice(2), 
                        file: new File([b], cleanName, { type: "audio/mpeg" }), 
                        status: 'pending', 
                        msg: 'Do ZIP', 
                        blob: null,
                        originalName: cleanName
                    });
                    count++;
                }
                notify(`${count} m√∫sicas extra√≠das`);
                updateState();
            } catch(e) { 
                console.error(e); 
                notify("N√£o √© um ZIP v√°lido", "error"); 
            }
            this.value = '';
        };

        // --- REMOVER M√öSICA ---
        window.remTrack = (id) => { 
            if(playingId === id) { document.getElementById('preview-audio').pause(); playingId = null; }
            tracks = tracks.filter(t => t.id !== id); 
            updateState(); 
        }

        // --- PLAYER DE PREVIEW ---
        const audioEl = document.getElementById('preview-audio');
        
        window.togglePlay = (id) => {
            const t = tracks.find(x => x.id === id);
            if(playingId === id) { 
                audioEl.pause(); 
                playingId = null; 
            } else { 
                if(t.blob) { 
                    audioEl.src = URL.createObjectURL(t.blob); 
                    audioEl.play(); 
                    playingId = id; 
                } 
            }
            updateState();
        }
        
        audioEl.onended = () => { playingId = null; updateState(); };
        
        // --- UI UPDATE ---
        function updateState() {
            const list = document.getElementById('list-container');
            const empty = document.getElementById('empty-msg');
            const btn = document.getElementById('btn-process');
            const activeV = vinhetaSlots.some(v=>v !== null); 
            
            document.getElementById('slot-counter').innerText = `${vinhetaSlots.filter(x=>x).length}/2`;
            document.getElementById('track-counter').innerText = `${tracks.length}/${MAX_TRACKS}`;

            if(tracks.length > 0) {
                empty.classList.add('hidden'); list.classList.remove('hidden');
                
                list.innerHTML = tracks.map(t => {
                    const isPlaying = playingId === t.id;
                    let statusIcon = '';
                    
                    if(t.status === 'done') statusIcon = `<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>`;
                    else if(t.status === 'error') statusIcon = `<i data-lucide="alert-triangle" class="w-4 h-4 text-red-500"></i>`;
                    else if(t.status === 'processing') statusIcon = `<i data-lucide="loader-2" class="w-4 h-4 text-yellow-500 spin"></i>`;
                    else statusIcon = `<i data-lucide="file-audio" class="w-4 h-4 text-zinc-600"></i>`;

                    let action = '';
                    if(t.status === 'done') {
                        action = `
                        <button onclick="togglePlay('${t.id}')" class="w-8 h-8 rounded-full ${isPlaying ? 'bg-white text-black' : 'bg-zinc-800 text-green-400'} flex items-center justify-center transition-colors">
                            <i data-lucide="${isPlaying ? 'pause' : 'play'}" class="w-3 h-3 fill-current"></i>
                        </button>`;
                    }

                    let textColor = t.status === 'error' ? 'text-red-400' : 'text-zinc-500';

                    return `
                    <div class="card p-3 flex items-center justify-between group">
                        <div class="flex items-center gap-3 overflow-hidden flex-1">
                            <div class="shrink-0 w-8 h-8 flex items-center justify-center bg-zinc-900/50 rounded-lg">
                                ${statusIcon}
                            </div>
                            <div class="min-w-0">
                                <div class="text-xs text-white truncate font-medium">${t.originalName}</div>
                                <div class="text-[10px] ${textColor} flex items-center gap-1">
                                    ${t.msg}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 pl-2">
                            ${action}
                            <button onclick="remTrack('${t.id}')" class="p-2 text-zinc-600 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            } else {
                empty.classList.remove('hidden'); list.classList.add('hidden');
            }

            const canProcess = activeV && tracks.length > 0;
            const allDone = tracks.length > 0 && tracks.every(t => t.status === 'done' || t.status === 'error');
            const hasSuccess = tracks.some(t => t.status === 'done');
            
            if(isProcessing) {
                btn.disabled = true; 
                btn.className = "flex-1 bg-zinc-800 text-zinc-400 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> PROCESSANDO...`;
            } else if(allDone) {
                btn.className = "flex-1 bg-zinc-900 text-zinc-500 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerText = "FINALIZADO";
                btn.disabled = true;
                if(hasSuccess) document.getElementById('btn-download').classList.remove('hidden');
            } else if(canProcess) {
                btn.disabled = false; 
                btn.className = "flex-1 bg-green-600 text-white h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(34,197,94,0.3)] active:scale-95 transition-all";
                btn.innerHTML = `INICIAR MIXAGEM`;
                document.getElementById('btn-download').classList.add('hidden');
            } else {
                btn.disabled = true; 
                btn.className = "flex-1 bg-zinc-900 text-zinc-600 h-14 rounded-xl font-bold text-sm flex items-center justify-center gap-2";
                btn.innerText = !activeV ? "FALTA VINHETA" : "ADD M√öSICAS";
                document.getElementById('btn-download').classList.add('hidden');
            }
            lucide.createIcons();
        }

        // --- CORE AUDIO ENGINE ---
        async function startProcessing() {
            if(isProcessing) return;
            initAudio();
            isProcessing = true; 
            updateState();

            // Pega a primeira vinheta v√°lida (simplificado)
            const vinheta = vinhetaSlots.find(v => v !== null);
            if(!vinheta) { notify("Erro: Vinheta sumiu!", "error"); isProcessing=false; return; }

            const posMode = document.getElementById('sel-pos').value;
            const mixMode = document.getElementById('sel-mix').value;

            for(let i=0; i<tracks.length; i++) {
                if(tracks[i].status === 'done' || tracks[i].status === 'error') continue;

                tracks[i].status = 'processing'; 
                tracks[i].msg = 'Lendo...';
                updateState();

                await new Promise(r => setTimeout(r, 50)); // UI Breath

                try {
                    // 1. Tenta Decodificar (Aqui pega erro se for PDF/Img)
                    const ab = await tracks[i].file.arrayBuffer();
                    let trackBuffer;
                    try {
                        trackBuffer = await audioCtx.decodeAudioData(ab);
                    } catch(decodeErr) {
                        throw new Error("Arquivo n√£o √© √°udio suportado");
                    }

                    // 2. Calculate Position
                    let startTime = 0;
                    const vDur = vinheta.duration;
                    const tDur = trackBuffer.duration;

                    if (posMode === 'safeEnd') {
                        startTime = Math.max(0, tDur - vDur - 15);
                    } else if (posMode === 'intro') {
                        startTime = Math.min(15, tDur / 2); 
                    } else if (posMode === 'middle') {
                        startTime = (tDur / 2) - (vDur / 2);
                    } else {
                        startTime = 0; 
                    }

                    // 3. Render Offline
                    const offlineCtx = new OfflineAudioContext(2, trackBuffer.length, trackBuffer.sampleRate);
                    
                    const musicSrc = offlineCtx.createBufferSource();
                    musicSrc.buffer = trackBuffer;
                    
                    const vinhetaSrc = offlineCtx.createBufferSource();
                    vinhetaSrc.buffer = vinheta.buffer;

                    const musicGain = offlineCtx.createGain();
                    const vinhetaGain = offlineCtx.createGain();

                    // L√≥gica de Mixagem
                    if (mixMode === 'ducking') {
                        musicGain.gain.setValueAtTime(1, startTime);
                        musicGain.gain.linearRampToValueAtTime(0.3, startTime + 0.2);
                        musicGain.gain.setValueAtTime(0.3, startTime + vDur - 0.2);
                        musicGain.gain.linearRampToValueAtTime(1, startTime + vDur);
                        vinhetaGain.gain.value = 1.0;
                    } else if (mixMode === 'cut') {
                        musicGain.gain.setValueAtTime(1, startTime);
                        musicGain.gain.linearRampToValueAtTime(0, startTime + 0.05);
                        musicGain.gain.setValueAtTime(0, startTime + vDur - 0.05);
                        musicGain.gain.linearRampToValueAtTime(1, startTime + vDur);
                        vinhetaGain.gain.value = 1.0;
                    } else {
                        musicGain.gain.value = 1.0;
                        vinhetaGain.gain.value = 1.2;
                    }

                    musicSrc.connect(musicGain);
                    musicGain.connect(offlineCtx.destination);
                    
                    vinhetaSrc.connect(vinhetaGain);
                    vinhetaGain.connect(offlineCtx.destination);

                    musicSrc.start(0);
                    vinhetaSrc.start(startTime);

                    tracks[i].msg = 'Mixando...'; updateState();
                    const renderedBuffer = await offlineCtx.startRendering();

                    tracks[i].msg = 'Salvando...'; updateState();
                    tracks[i].blob = bufferToWave(renderedBuffer, renderedBuffer.length);
                    tracks[i].status = 'done';
                    tracks[i].msg = 'Mixado';

                    tracks[i].file = null; // Clean RAM

                } catch(e) {
                    console.log("Erro no arquivo:", tracks[i].originalName);
                    tracks[i].status = 'error';
                    tracks[i].msg = 'Arquivo inv√°lido';
                }
            }

            isProcessing = false;
            updateState();
            
            if(tracks.some(t => t.status === 'done')) {
                notify("Conclu√≠do! Verifique a lista.", "success");
            } else {
                notify("Nenhum √°udio foi processado.", "error");
            }
        }

        // --- WAV ENCODER ---
        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels,
                length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                offset = 0,
                pos = 0;

            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }

            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8); 
            setUint32(0x45564157); // "WAVE"

            setUint32(0x20746d66); // "fmt "
            setUint32(16); 
            setUint16(1); 
            setUint16(numOfChan);
            setUint32(abuffer.sampleRate);
            setUint32(abuffer.sampleRate * 2 * numOfChan); 
            setUint16(numOfChan * 2); 
            setUint16(16); 

            setUint32(0x61746164); // "data"
            setUint32(length - pos - 4); 

            for(i = 0; i < numOfChan; i++) channels.push(abuffer.getChannelData(i));

            while(pos < length) {
                for(i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][offset])); 
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0; 
                    view.setInt16(pos, sample, true); 
                    pos += 2;
                }
                offset++;
            }

            return new Blob([buffer], { type: "audio/wav" });
        }

        // --- DOWNLOAD ZIP ---
        async function downloadZip() {
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> COMPRIMINDO...`;
                lucide.createIcons();

                const zip = new JSZip();
                const folder = zip.folder("SuitCds_Mixes");
                let count = 0;

                tracks.forEach((t, idx) => {
                    if (t.status === 'done' && t.blob) {
                        let safeName = t.originalName.replace(/\.[^/.]+$/, "");
                        let fileName = `${String(idx+1).padStart(2, '0')} - ${safeName} (SuitCds).wav`;
                        folder.file(fileName, t.blob);
                        count++;
                    }
                });

                if(count === 0) {
                    notify("Nada para baixar.", "error");
                    return;
                }

                const content = await zip.generateAsync({
                    type: "blob", 
                    compression: "DEFLATE", 
                    compressionOptions: { level: 6 } 
                }, (metadata) => {
                    btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> ${metadata.percent.toFixed(0)}%`;
                });

                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = "SuitCds_Pack_Universal.zip";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

            } catch(e) {
                console.error(e);
                notify("Erro ao criar ZIP", "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>

